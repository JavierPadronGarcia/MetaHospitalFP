//! mingo.js 2.4.0
//! Copyright (c) 2019 Francis Asante
//! MIT
!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(n=n||self).mingo=t()}(this,function(){"use strict";var u="null",i="undefined",o="boolean",a="number",s="string",c="date",f="regexp",l="array",v="object",h="function",p=[u,i,o,a,s,c,f],d="expression",$="group",g="pipeline",m="projection",y="query",b=function(){};Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(n,t){if(null==this)throw new TypeError('"this" is null or not defined');var r=Object(this),e=r.length>>>0;if(0==e)return!1;var u,i,o=0|t,a=Math.max(0<=o?o:e-Math.abs(o),0);for(;a<e;){if((u=r[a])===(i=n)||"number"==typeof u&&"number"==typeof i&&isNaN(u)&&isNaN(i))return!0;a++}return!1}});var _=Array.prototype.push;function x(n,t){n||B(t)}function k(n){switch(M(n)){case l:return n.map(k);case v:return Y(n,k);default:return n}}function O(n){switch(M(n)){case l:return rn([],n);case v:return Object.assign({},n);default:return n}}function w(n){return null===n?"Null":void 0===n?"Undefined":n.constructor.name}function M(n){return w(n).toLowerCase()}function j(n){return M(n)===o}function A(n){return M(n)===s}function N(n){return M(n)===a}var E=Array.isArray||function(n){return!!n&&n.constructor===Array};function S(n){return!!n&&n.constructor===Object}function I(n){return n===Object(n)}function P(n){return M(n)===c}function C(n){return M(n)===f}function r(n){return M(n)===h}function T(n){return e(n)||t(n)}function e(n){return null===n}function t(n){return void 0===n}function q(n,t){return n.includes(t)}function F(n,t){return!q(n,t)}function L(n){return!!n}function R(n){return T(n)||E(n)&&0===n.length||S(n)&&0===z(n).length||!n}function D(n){return E(n)?n:[n]}function U(n,t){return n.hasOwnProperty(t)}function B(n){throw new Error(n)}var z=Object.keys;function V(n,t,r){if(t=t.bind(r),E(n))for(var e=0,u=n.length;e<u&&!1!==t(n[e],e,n);e++);else for(var i in n)if(n.hasOwnProperty(i)&&!1===t(n[i],i,n))break}function Y(n,t,r){t=t.bind(r);for(var e={},u=z(n),i=0;i<u.length;i++){var o=u[i];e[o]=t(n[o],o)}return e}function J(r,e,u){return E(r)?r.reduce(e,u):(V(r,function(n,t){return u=e(u,n,t,r)}),u)}function H(n,t){var r=t.map(X);return n.filter(function(n){return q(r,X(n))})}function K(n,t){var i=[];return function n(t,r){for(var e=0,u=t.length;e<u;e++)E(t[e])&&(0<r||r<0)?n(t[e],Math.max(-1,r-1)):i.push(t[e])}(n,1<arguments.length&&void 0!==t?t:-1),i}function Q(n,t){for(var r=[n],e=[t];0<r.length;)if((n=r.pop())!==(t=e.pop())){var u=M(n);if(u!==M(t)||u===h)return!1;switch(u){case l:if(n.length!==t.length)return!1;rn(r,n),rn(e,t);break;case v:var i=z(n),o=z(t);if(i.length!==o.length)return!1;i.sort(),o.sort();for(var a=0,s=i.length;a<s;a++){var c=i[a];if(c!==o[a])return!1;r.push(n[c]),e.push(t[c])}break;default:if(G(n)!==G(t))return!1}}return 0===r.length}function W(n){var r={},e=[];return V(n,function(n){var t=X(n);U(r,t)||(e.push(n),r[t]=0)}),e}function G(t){var n=M(t);switch(n){case o:case a:case f:return t.toString();case s:return JSON.stringify(t);case c:return t.toISOString();case u:case i:return n;case l:return"["+t.map(G)+"]";default:var r=n===v?"":"".concat(w(t)),e=z(t);return e.sort(),"".concat(r,"{")+e.map(function(n){return"".concat(G(n),":").concat(G(t[n]))})+"}"}}function X(n){if(T(n))return null;for(var t=0,r=G(n),e=r.length;e;)t=(t<<5)-t^r.charCodeAt(--e);return t>>>0}function Z(n,t){return n<t?-1:t<n?1:0}function nn(n,t,r){var e=[],u=[],i=new Map;if(r=r||Z,R(n))return n;for(var o=0;o<n.length;o++){var a=n[o],s=t(a,o);T(s)?u.push(a):(i.has(s)?i.get(s).push(a):i.set(s,[a]),e.push(s))}e.sort(r);for(var c=0;c<e.length;c++)rn(u,i.get(e[c]));return i.clear(),u}function tn(n,u){var i={keys:[],groups:[]},o={};return V(n,function(n){var t=u(n),r=X(t),e=-1;void 0===o[r]&&(e=i.keys.length,o[r]=e,i.keys.push(t),i.groups.push([])),e=o[r],i.groups[e].push(n)}),i}function rn(n,t){return _.apply(n,t),n}function en(u){var i,o=this;return i={},function(){for(var n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];var e=X(t);return U(i,e)||(i[e]=u.apply(o,t)),i[e]}}var n={$abs:function(n,t){var r=ot(n,t);return null==r?null:Math.abs(r)},$add:function(n,t){var r=ot(n,t),e=!1,u=J(r,function(n,t){return P(t)&&(x(!e,"'$add' can only have one date value"),e=!0,t=t.getTime()),n+=t},0);return e?new Date(u):u},$ceil:function(n,t){var r=ot(n,t);return T(r)?null:(x(N(r)||isNaN(r),"$ceil expression must resolve to a number."),Math.ceil(r))},$divide:function(n,t){var r=ot(n,t);return r[0]/r[1]},$exp:function(n,t){var r=ot(n,t);return T(r)?null:(x(N(r)||isNaN(r),"$exp expression must resolve to a number."),Math.exp(r))},$floor:function(n,t){var r=ot(n,t);return T(r)?null:(x(N(r)||isNaN(r),"$floor expression must resolve to a number."),Math.floor(r))},$ln:function(n,t){var r=ot(n,t);return T(r)?null:(x(N(r)||isNaN(r),"$ln expression must resolve to a number."),Math.log(r))},$log:function(n,t){var r=ot(n,t),e="$log expression must resolve to array(2) of numbers";return x(E(r)&&2===r.length,e),r.some(T)?null:(x(r.some(isNaN)||r.every(N),e),Math.log10(r[0])/Math.log10(r[1]))},$log10:function(n,t){var r=ot(n,t);return T(r)?null:(x(N(r)||isNaN(r),"$log10 expression must resolve to a number."),Math.log10(r))},$mod:function(n,t){var r=ot(n,t);return r[0]%r[1]},$multiply:function(n,t){return J(ot(n,t),function(n,t){return n*t},1)},$pow:function(n,t){var r=ot(n,t);return x(E(r)&&2===r.length&&r.every(N),"$pow expression must resolve to array(2) of numbers"),x(!(0===r[0]&&r[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(r[0],r[1])},$sqrt:function(n,t){var r=ot(n,t);return T(r)?null:(x(N(r)&&0<r||isNaN(r),"$sqrt expression must resolve to non-negative number."),Math.sqrt(r))},$subtract:function(n,t){var r=ot(n,t);return r[0]-r[1]},$trunc:function(n,t){var r=ot(n,t);return T(r)?null:(x(N(r)||isNaN(r),"$trunc expression must resolve to a number."),Math.trunc(r))}},un={$arrayElemAt:function(n,t){var r=ot(n,t);x(E(r)&&2===r.length,"$arrayElemAt expression must resolve to array(2)"),x(E(r[0]),"First operand to $arrayElemAt must resolve to an array"),x(N(r[1]),"Second operand to $arrayElemAt must resolve to an integer");var e=r[1];return r=r[0],e<0&&Math.abs(e)<=r.length?r[e+r.length]:0<=e&&e<r.length?r[e]:void 0},$arrayToObject:function(n,t){var r=ot(n,t);return x(E(r),"$arrayToObject expression must resolve to an array"),J(r,function(n,t){return E(t)&&2==t.length?n[t[0]]=t[1]:(x(S(t)&&U(t,"k")&&U(t,"v"),"$arrayToObject expression is invalid."),n[t.k]=t.v),n},{})},$concatArrays:function(n,t){var r=ot(n,t,null);return x(E(r),"$concatArrays must resolve to an array"),r.some(T)?null:r.reduce(function(n,t){return rn(n,t)},[])},$filter:function(n,t){var r=ot(n,t.input),e=t.as,u=t.cond;return x(E(r),"$filter 'input' expression must resolve to an array"),r.filter(function(n){var t={};return t["$"+e]=n,!0===ot(t,u)})},$in:function(n,t){var r=ot(n,t[0]),e=ot(n,t[1]);return x(E(e),"$in second argument must be an array"),e.some(Q.bind(null,r))},$indexOfArray:function(n,t){var r=ot(n,t);if(T(r))return null;var e=r[0],u=r[1];if(T(e))return null;x(E(e),"$indexOfArray expression must resolve to an array.");var i=r[2]||0,o=r[3];return T(o)&&(o=e.length),o<i?-1:(x(0<=i&&0<=o,"$indexOfArray expression is invalid"),(0<i||o<e.length)&&(e=e.slice(i,o)),e.findIndex(Q.bind(null,u))+i)},$isArray:function(n,t){return E(ot(n,t[0]))},$map:function(t,n){var r=ot(t,n.input);x(E(r),"$map 'input' expression must resolve to an array");var e=n.as,u=n.in,i="$"+e;return r.map(function(n){return t[i]=n,ot(t,u)})},$objectToArray:function(n,t){var r=ot(n,t);x(S(r),"$objectToArray expression must resolve to an object");var e=[];return V(r,function(n,t){return e.push({k:t,v:n})}),e},$range:function(n,t){for(var r=ot(n,t),e=r[0],u=r[1],i=r[2]||1,o=[];e<u&&0<i||u<e&&i<0;)o.push(e),e+=i;return o},$reduce:function(n,t){var r=ot(n,t.input),e=ot(n,t.initialValue),u=t.in;return T(r)?null:(x(E(r),"$reduce 'input' expression must resolve to an array"),J(r,function(n,t){return ot({$value:n,$this:t},u)},e))},$reverseArray:function(n,t){var r=ot(n,t);if(T(r))return null;x(E(r),"$reverseArray expression must resolve to an array");var e=[];return rn(e,r),e.reverse(),e},$size:function(n,t){var r=ot(n,t);return E(r)?r.length:void 0},$slice:function(n,t){var r=ot(n,t);return at(r[0],r[1],r[2])},$zip:function(n,t){var e=ot(n,t.inputs),r=t.useLongestLength||!1;x(E(e),"'inputs' expression must resolve to an array"),x(j(r),"'useLongestLength' must be a boolean"),E(t.defaults)&&x(L(r),"'useLongestLength' must be set to true to use 'defaults'");for(var u=0,i=0,o=e.length;i<o;i++){var a=e[i];if(T(a))return null;x(E(a),"'inputs' expression values must resolve to an array or null"),u=r?Math.max(u,a.length):Math.min(u||a.length,a.length)}for(var s=[],c=t.defaults||[],f=function(r){var n=e.map(function(n,t){return T(n[r])?c[t]||null:n[r]});s.push(n)},l=0;l<u;l++)f(l);return s},$mergeObjects:function(n,t){var r=ot(n,t);return E(r)?J(r,function(n,t){return Object.assign(n,t)},{}):{}}},on={$and:function(n,t){var r=ot(n,t);return L(r)&&r.every(L)},$or:function(n,t){var r=ot(n,t);return L(r)&&r.some(L)},$not:function(n,t){return!ot(n,t[0])}};function an(n){return(an="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n})(n)}function sn(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")}function cn(n,t){for(var r=0;r<t.length;r++){var e=t[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(n,e.key,e)}}function fn(n,t,r){return t&&cn(n.prototype,t),r&&cn(n,r),n}function ln(n,u,t){var i=z(u);return 0===i.length?n:n.map(function(r){var e=k(r);return V(i,function(n){var t=ot(r,u[n]);rt(e,n,t)}),e})}function vn(n){return n instanceof _n?n:new _n(n)}function hn(n){return!!n&&"object"===an(n)&&pn(n.next)}function pn(n){return!!n&&"function"==typeof n}vn.isIterator=hn;var dn=new Error,$n=1,gn=2,mn=3,yn=4;function bn(f,l,v){var h=!1,p=-1,d=0;return function(n){n=n===v;try{n:for(;!h;){var t=f();p++;for(var r=-1,e=l.length,u=!1;++r<e;){var i=l[r],o=i.func;switch(i.type){case $n:t=o(t,p);break;case gn:if(!o(t,p))continue n;break;case mn:--i.func,i.func||(u=!0);break;case yn:--i.func,i.func||(s=r,void 0,c=(a=l).slice(s+1),a.splice(s),Array.prototype.push.apply(a,c));continue n;default:break n}}if(h=u,!n)return{value:t,done:!1};v[d++]=t}}catch(n){if(n!==dn)throw n}var a,s,c;return{done:h=!0}}}var _n=function(){function i(n){if(sn(this,i),this.__iteratees=[],this.__first=!1,this.__done=!1,this.__buf=[],pn(n)&&(n={next:n}),hn(n)){var t=n;n=function(){var n=t.next();if(n.done)throw dn;return n.value}}else if(Array.isArray(n)){var r=n,e=r.length,u=0;n=function(){if(u<e)return r[u++];throw dn}}else if(!pn(n))throw new Error("Source is not iterable. Must be Array, Function or Object{next:Function}");this.next=bn(n,this.__iteratees,this.__buf)}return fn(i,[{key:Symbol.iterator,value:function(){return this}},{key:"_validate",value:function(){if(this.__first)throw new Error("Cannot add iteratee/transform after `first()`")}},{key:"_push",value:function(n){return this._validate(),this.__iteratees.push(n),this}},{key:"map",value:function(n){return this._push({type:$n,func:n})}},{key:"filter",value:function(n){return this._push({type:gn,func:n})}},{key:"take",value:function(n){return 0<n?this._push({type:mn,func:n}):this}},{key:"drop",value:function(n){return 0<n?this._push({type:yn,func:n}):this}},{key:"transform",value:function(n){this._validate();var t,r=this;return vn(function(){return(t=t||vn(n(r.value()))).next()})}},{key:"first",value:function(){return this.take(1),this.__first=!0,this}},{key:"value",value:function(){return this.__done||(this.__done=this.next(this.__buf).done),this.__first?this.__buf[0]:this.__buf}},{key:"each",value:function(n){for(;;){var t=this.next();if(t.done)break;if(!1===n(t.value))return!1}return!0}},{key:"reduce",value:function(n,t){var r=this.next(),e=0;for(void 0!==t||r.done||(t=r.value,r=this.next(),e++);!r.done;)t=n(t,r.value,e++),r=this.next();return t}},{key:"size",value:function(){return this.reduce(function(n,t){return++n},0)}}]),i}();var xn={$:function(){B("$ not implemented")},$elemMatch:function(n,t,r){var e=Zn(n,r),u=new An(t);x(E(e),"$elemMatch: invalid argument");for(var i=0;i<e.length;i++)if(u.test(e[i]))return[e[i]]},$slice:function(n,t,r){var e=Zn(n,r);return E(e)?E(t)?at(e,t[0],t[1]):(x(N(t),"$slice: invalid arguments for projection"),at(e,t)):e}};var kn={1:"base",2:"accent",3:"variant"};var On={$addFields:ln,$bucket:function(n,u,t){var i=u.boundaries,o=u.default,a=i[0],s=i[i.length-1],r=u.output||{count:{$sum:1}};x(2<i.length,"$bucket 'boundaries' expression must have at least 3 elements");for(var e=w(a),c=0,f=i.length-1;c<f;c++)x(e===w(i[c+1]),"$bucket 'boundaries' must all be of the same type"),x(i[c]<i[c+1],"$bucket 'boundaries' must be sorted in ascending order");T(o)||w(u.default)!==w(a)||x(a>u.default||s<u.default,"$bucket 'default' expression must be out of boundaries range");var l={};V(i,function(n){return l[n]=[]}),T(o)||(l[o]=[]);var v=!1;return vn(function(){return v||(n.each(function(n){var t=ot(n,u.groupBy);if(T(t)||t<a||s<=t)x(!T(o),"$bucket require a default for out of range values"),l[o].push(n);else{x(a<=t&&t<s,"$bucket 'groupBy' expression must resolve to a value in range of boundaries");var r=function(n,t){for(var r=0,e=n.length-1;r<=e;){var u=Math.round(r+(e-r)/2);if(t<n[u])e=u-1;else{if(!(t>n[u]))return u;r=u+1}}return r}(i,t),e=i[Math.max(0,r-1)];l[e].push(n)}}),i.pop(),T(o)||i.push(o),v=vn(i).map(function(n){var t=Xn(l[n],null,r);return Object.assign(t,{_id:n})})),v.next()})},$bucketAuto:function(n,t,r){var d=t.output||{count:{$sum:1}},$=t.groupBy,g=t.buckets;return x(0<g,"The $bucketAuto 'buckets' field must be greater than 0, but found: "+g),n.transform(function(n){for(var t=Math.max(1,Math.round(n.length/g)),r=en(ot),e={},u=[],i=nn(n,function(n){var t=r(n,$);return T(t)?u.push(n):(e[t]||(e[t]=[]),e[t].push(n)),t}),o=Wn(),a=[],s=0,c=0,f=i.length;c<g&&s<f;c++){for(var l={},v=[],h=0;h<t&&s<f;h++){var p=r(i[s],$);if(T(p)&&(p=null),rn(v,T(p)?u:e[p]),s+=T(p)?u.length:e[p].length,U(l,"min")||(l.min=p),0<a.length)a[a.length-1][o].max=l.min}c==g-1&&rn(v,i.slice(s)),a.push(Object.assign(Xn(v,null,d),{_id:l}))}return 0<a.length&&(a[a.length-1][o].max=r(i[i.length-1],$)),a})},$count:function(t,r,n){return x(A(r)&&""!==r.trim()&&-1===r.indexOf(".")&&"$"!==r.trim()[0],"Invalid expression value for $count"),vn(function(){var n={};return n[r]=t.size(),{value:n,done:!1}}).first()},$facet:function(n,r,t){return n.transform(function(t){return[Y(r,function(n){return Mn(t,n)})]})},$group:function(n,i,t){var o=Wn(),r=i[o];return n.transform(function(n){var e=tn(n,function(n){return ot(n,r,r)});delete(i=O(i))[o];var u=-1,t=e.keys.length;return function(){if(++u===t)return{done:!0};var n=e.keys[u],r={};return void 0!==n&&(r[o]=n),V(i,function(n,t){r[t]=Xn(e.groups[u],t,n)}),{value:r,done:!1}}})},$limit:function(n,t,r){return n.take(t)},$lookup:function(n,t,r){var e=t.from,u=t.localField,i=t.foreignField,o=t.as;x(E(e)&&A(i)&&A(u)&&A(o),"$lookup: invalid argument");var a={};return V(e,function(n){var t=X(n[i]);a[t]=a[t]||[],a[t].push(n)}),n.map(function(n){var t=X(n[u]),r=O(n);return r[o]=a[t]||[],r})},$match:function(n,t,r){var e=new An(t);return n.filter(function(n){return e.test(n)})},$out:function(n,t,r){return x(E(t),"$out expression must be an array"),n.map(function(n){return t.push(n),n})},$project:function(n,f,t){if(R(f))return n;var r=z(f),e=!1,l=Wn(),u=[!1,!1];if(V(f,function(n,t){t!==l&&(0===n||!1===n?u[0]=!0:u[1]=!0,x(u[0]!==u[1],"Projection cannot have a mix of inclusion and exclusion."))}),q(r,l)){var i=f[l];0!==i&&!1!==i||(x(F(r=r.filter(F.bind(null,[l])),l),"Must not contain collections id key"),e=R(r))}else r.push(l);return n.map(function(i){var o={},a=!1,s=!1,c=[];return e&&c.push(l),V(r,function(n){var t,r=f[n];if(n!==l&&q([0,!1],r)&&(s=!0),n===l&&R(r))t=i[n];else if(A(r))t=ot(i,r,n);else if(q([1,!0],r));else{if(!S(r))return void c.push(n);var e=z(r);e=!(1<e.length)&&e[0],q(Vn(m),e)?"$slice"===e?D(r[e]).every(N)?(t=xn[e](i,r[e],n),a=!0):t=ot(i,r,n):t=xn[e](i,r[e],n):t=ot(i,r,n)}var u=nt(i,n,{preserveMissingValues:!0});void 0!==u&&!function t(r,e,n){var u=2<arguments.length&&void 0!==n?n:{};if(r===b)return e;if(e===b)return r;var i=[r,e];if(!i.every(S)&&!i.every(E))throw Error("mismatched types. must both be array or object");if(u.flatten=u.flatten||!1,E(r))if(u.flatten){for(var o=0,a=0;o<r.length&&a<e.length;)r[o]=t(r[o++],e[a++],u);for(;a<e.length;)r.push(e[a++])}else _.apply(r,e);else Object.keys(e).forEach(function(n){r.hasOwnProperty(n)?r[n]=t(r[n],e[n],u):r[n]=e[n]});return r}(o,u,{flatten:!0}),F([0,1,!1,!0],r)&&(void 0===t?et(o,n):rt(o,n,t))}),function n(t){if(E(t))for(var r=t.length-1;0<=r;r--)t[r]===b?t.splice(r,1):n(t[r]);else if(S(t))for(var e in t)t.hasOwnProperty(e)&&n(t[e]);return t}(o),(a||s||e)&&(o=Object.assign({},i,o),0<c.length&&(o=k(o),V(c,function(n){return et(o,n)}))),o})},$redact:function(n,t,r){return n.map(function(n){return ct(k(n),t)})},$replaceRoot:function(n,t,r){return n.map(function(n){return x(S(n=ot(n,t.newRoot)),"$replaceRoot expression must return an object"),n})},$sample:function(n,t,r){var u=t.size;return x(N(u),"$sample size must be a positive integer"),n.transform(function(t){var r=t.length,e=-1;return function(){if(++e===u)return{done:!0};var n=Math.floor(Math.random()*r);return{value:t[n],done:!1}}})},$set:function(){return ln.apply(void 0,arguments)},$skip:function(n,t,r){return n.drop(t)},$sort:function(n,i,t){if(R(i)||!S(i))return n;var o=Z,r=(t=t||{}).collation;return S(r)&&A(r.locale)&&(o=function(n){var t={sensitivity:kn[n.strength||3],caseFirst:"off"===n.caseFirst?"false":n.caseFirst||"false",numeric:n.numericOrdering||!1,ignorePunctuation:"shifted"===n.alternate};!0===(n.caseLevel||!1)&&("base"===t.sensitivity&&(t.sensitivity="case"),"accent"===t.sensitivity&&(t.sensitivity="variant"));var e=new Intl.Collator(n.locale,t);return function(n,t){if(!A(n)||!A(t))return Z(n,t);var r=e.compare(n,t);return r<0?-1:0<r?1:0}}(r)),n.transform(function(u){return V(z(i).reverse(),function(t){var r=tn(u,function(n){return Zn(n,t)}),e=new Map,n=nn(r.keys,function(n,t){return e.set(n,t),n},o);-1===i[t]&&n.reverse(),u=[],V(n,function(n){return rn(u,r.groups[e.get(n)])}),e.clear()}),u})},$sortByCount:function(n,t,r){var e={count:{$sum:1}};return e[Wn()]=t,this.$sort(this.$group(n,e),{count:-1},r)},$unwind:function(u,n,t){function i(n,t){return!1!==r&&(n[r]=t),n}A(n)&&(n={path:n});var o,a=n.path.substr(1),r=n.includeArrayIndex||!1,s=n.preserveNullAndEmptyArrays||!1;return vn(function(){for(var n=function(){if(vn.isIterator(o)){var n=o.next();if(!n.done)return{v:n}}var e=u.next();if(e.done)return{v:e};if(e=e.value,o=Zn(e,a),E(o)){if(0===o.length&&!0===s){o=null;var t=k(e);return et(t,a),{v:{value:i(t,null),done:!1}}}o=vn(o).map(function(n,t){var r=k(e);return rt(r,a,n),i(r,t)})}else if(!R(o)||!0===s){var r=k(e);return{v:{value:i(r,null),done:!1}}}};;){var t=n();if("object"===an(t))return t.v}})}},wn=function(){function r(n,t){sn(this,r),this.__operators=n,this.__options=t}return fn(r,[{key:"stream",value:function(r,e){var u=this;return r=vn(r),R(this.__operators)||V(this.__operators,function(n){var t=z(n);x(1===t.length&&q(Vn(g),t[0]),"invalid aggregation operator ".concat(t)),t=t[0],r=e&&e instanceof An?On[t].call(e,r,n[t],u.__options):On[t](r,n[t],u.__options)}),r}},{key:"run",value:function(n,t){return this.stream(n,t).value()}}]),r}();function Mn(n,t,r){return x(E(t),"Aggregation pipeline must be an array"),new wn(t,r).run(n)}var jn=function(){function e(n,t,r){sn(this,e),this.__filterFn=t.test.bind(t),this.__query=t,this.__source=n,this.__projection=r||t.__projection,this.__operators=[],this.__result=null,this.__stack=[],this.__options={}}return fn(e,[{key:"_fetch",value:function(){return this.__result||(S(this.__projection)&&this.__operators.push({$project:this.__projection}),this.__result=vn(this.__source).filter(this.__filterFn),0<this.__operators.length&&(this.__result=new wn(this.__operators,this.__options).stream(this.__result,this.__query))),this.__result}},{key:"all",value:function(){return this._fetch().value()}},{key:"count",value:function(){return this.all().length}},{key:"skip",value:function(n){return this.__operators.push({$skip:n}),this}},{key:"limit",value:function(n){return this.__operators.push({$limit:n}),this}},{key:"sort",value:function(n){return this.__operators.push({$sort:n}),this}},{key:"collation",value:function(n){return this.__options.collation=n,this}},{key:"next",value:function(){if(this.__stack){if(0<this.__stack.length)return this.__stack.pop();var n=this._fetch().next();if(!n.done)return n.value;this.__stack=null}}},{key:"hasNext",value:function(){if(!this.__stack)return!1;if(0<this.__stack.length)return!0;var n=this._fetch().next();return n.done?this.__stack=null:this.__stack.push(n.value),!!this.__stack}},{key:"map",value:function(n){return this._fetch().map(n).value()}},{key:"forEach",value:function(n){this._fetch().each(n)}},{key:Symbol.iterator,value:function(){return this._fetch()}}]),e}(),An=function(){function r(n,t){sn(this,r),this.__criteria=n,this.__projection=t||{},this.__compiled=[],this._compile()}return fn(r,[{key:"_compile",value:function(){var t,e=this;x(S(this.__criteria),"query criteria must be an object"),V(this.__criteria,function(n,r){"$where"===r?t={field:r,expr:n}:"$expr"===r?e._processOperator(r,r,n):q(["$and","$or","$nor"],r)?e._processOperator(r,r,n):(x(!ut(r),"unknown top level operator: ".concat(r)),V(n=it(n),function(n,t){e._processOperator(r,t,n)})),S(t)&&e._processOperator(t.field,t.field,t.expr)})}},{key:"_processOperator",value:function(n,t,r){x(q(Vn(y),t),"Invalid query operator '"+t+"' detected"),this.__compiled.push(Sn[t](n,r))}},{key:"test",value:function(n){for(var t=0,r=this.__compiled.length;t<r;t++)if(!this.__compiled[t].test(n))return!1;return!0}},{key:"find",value:function(n,t){return new jn(n,this,t)}},{key:"remove",value:function(n){var r=this;return J(n,function(n,t){return r.test(t)||n.push(t),n},[])}}]),r}();function Nn(n,t,r){return D(n).some(function(n){return w(n)===w(t)&&r(n,t)})}var En={$eq:function(n,t){if(Q(n,t))return!0;if(T(n)&&T(t))return!0;if(E(n)){var r=Q.bind(null,t);return n.some(r)||K(n,1).some(r)}return!1},$ne:function(n,t){return!this.$eq(n,t)},$in:function(n,t){return T(n)?t.some(e):0<H(D(n),t).length},$nin:function(n,t){return!this.$in(n,t)},$lt:function(n,t){return Nn(n,t,function(n,t){return n<t})},$lte:function(n,t){return Nn(n,t,function(n,t){return n<=t})},$gt:function(n,t){return Nn(n,t,function(n,t){return t<n})},$gte:function(n,t){return Nn(n,t,function(n,t){return t<=n})},$mod:function(n,t){return D(n).some(function(n){return N(n)&&E(t)&&2===t.length&&n%t[0]===t[1]})},$regex:function(n,t){function r(n){return A(n)&&!!n.match(t)}return(n=D(n)).some(r)||K(n,1).some(r)},$exists:function(n,t){return(!1===t||0===t)&&void 0===n||(!0===t||1===t)&&void 0!==n},$all:function(n,t){var r=!1;if(E(n)&&E(t))for(var e=0,u=t.length;e<u;e++){if(!S(t[e])||!q(z(t[e]),"$elemMatch"))return H(t,n).length===u;r=r||this.$elemMatch(n,t[e].$elemMatch)}return r},$size:function(n,t){return E(n)&&N(t)&&n.length===t},$elemMatch:function(n,t){if(E(n)&&!R(n)){var r=function(n){return n},e=t;z(t).every(ut)&&(e={temp:t},r=function(n){return{temp:n}});for(var u=new An(e),i=0,o=n.length;i<o;i++)if(u.test(r(n[i])))return!0}return!1},$type:function(n,t){switch(t){case 1:case"double":return N(n)&&-1!==(n+"").indexOf(".");case 2:case s:return A(n);case 3:case v:return S(n);case 4:case l:return E(n);case 6:case i:return T(n);case 8:case"bool":return j(n);case 9:case c:return P(n);case 10:case u:return e(n);case 11:case"regex":return C(n);case 16:case"int":return N(n)&&n<=2147483647&&-1===(n+"").indexOf(".");case 18:case"long":return N(n)&&2147483647<n&&n<=0x8000000000000000&&-1===(n+"").indexOf(".");case 19:case"decimal":return N(n);default:return!1}}},Sn={$and:function(n,t){x(E(t),"Invalid expression: $and expects value to be an Array");var r=[];return V(t,function(n){return r.push(new An(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(!r[t].test(n))return!1;return!0}}},$or:function(n,t){x(E(t),"Invalid expression. $or expects value to be an Array");var r=[];return V(t,function(n){return r.push(new An(n))}),{test:function(n){for(var t=0;t<r.length;t++)if(r[t].test(n))return!0;return!1}}},$nor:function(n,t){x(E(t),"Invalid expression. $nor expects value to be an Array");var r=this.$or("$or",t);return{test:function(n){return!r.test(n)}}},$not:function(n,t){var r={};r[n]=it(t);var e=new An(r);return{test:function(n){return!e.test(n)}}},$where:function(n,t){return r(t)||(t=new Function("return "+t+";")),{test:function(n){return!0===t.call(n)}}},$expr:function(n,t){return{test:function(n){return ot(n,t)}}}};V(En,function(u,n){u=u.bind(En),Sn[n]=function(r,e){return{test:function(n){var t=Zn(n,r,{meta:!0});return t=function(n,t){if(t<1)return n;for(;t--&&E(n)&&1===n.length;)n=n[0];return n}(t.result,t.depth),u(t,e)}}}});var In={$cmp:function(n,t){var r=ot(n,t);return r[0]>r[1]?1:r[0]<r[1]?-1:0}};V(["$eq","$ne","$gt","$gte","$lt","$lte","$nin"],function(e){In[e]=function(n,t){var r=ot(n,t);return En[e](r[0],r[1])}});var Pn={$cond:function(n,t){var r,e,u,i="$cond: invalid arguments";return u=E(t)?(x(3===t.length,i),r=t[0],e=t[1],t[2]):(x(S(t),i),r=t.if,e=t.then,t.else),ot(n,ot(n,r)?e:u)},$switch:function(t,n){var r="Invalid arguments for $switch operator";x(n.branches,r);var e=n.branches.find(function(n){return x(n.case&&n.then,r),ot(t,n.case)});return e?ot(t,e.then):(x(n.default,r),ot(t,n.default))},$ifNull:function(n,t){x(E(t)&&2===t.length,"$ifNull expression must resolve to array(2)");var r=ot(n,t);return T(r[0])?r[1]:r[0]}},Cn={"%Y":["$year",4],"%m":["$month",2],"%d":["$dayOfMonth",2],"%H":["$hour",2],"%M":["$minute",2],"%S":["$second",2],"%L":["$millisecond",3],"%j":["$dayOfYear",3],"%w":["$dayOfWeek",1],"%U":["$week",2],"%%":"%"},Tn={$dayOfYear:function(n,t){var r=ot(n,t),e=new Date(r.getFullYear(),0,0),u=r-e;return Math.round(u/864e5)},$dayOfMonth:function(n,t){return ot(n,t).getDate()},$dayOfWeek:function(n,t){return ot(n,t).getDay()+1},$year:function(n,t){return ot(n,t).getFullYear()},$month:function(n,t){return ot(n,t).getMonth()+1},$week:function(n,t){var r=ot(n,t);(r=new Date(+r)).setHours(0,0,0),r.setDate(r.getDate()+4-(r.getDay()||7));var e=new Date(r.getFullYear(),0,1);return Math.floor(((r-e)/864e5+1)/7)},$hour:function(n,t){return ot(n,t).getUTCHours()},$minute:function(n,t){return ot(n,t).getMinutes()},$second:function(n,t){return ot(n,t).getSeconds()},$millisecond:function(n,t){return ot(n,t).getMilliseconds()},$dateToString:function(n,t){for(var r,e,u=t.format,i=ot(n,t.date),o=u.match(/(%%|%Y|%m|%d|%H|%M|%S|%L|%j|%w|%U)/g),a=0,s=o.length;a<s;a++){var c=Cn[o[a]],f=c;if(E(c)){var l=this[c[0]].bind(this),v=c[1];r=l(n,i),e=v,f=new Array(Math.max(e-String(r).length+1,0)).join("0")+r}u=u.replace(o[a],f)}return u}};var qn={$setEquals:function(n,t){var r=ot(n,t),e=W(r[0]),u=W(r[1]);return e.length===u.length&&e.length===H(e,u).length},$setIntersection:function(n,t){var r=ot(n,t);return H(r[0],r[1])},$setDifference:function(n,t){var r=ot(n,t);return r[0].filter(F.bind(null,r[1]))},$setUnion:function(n,t){var r=ot(n,t);return function(n,t){return rn(rn([],n),t.filter(F.bind(null,n)))}(r[0],r[1])},$setIsSubset:function(n,t){var r=ot(n,t);return H(r[0],r[1]).length===r[0].length},$anyElementTrue:function(n,t){return ot(n,t)[0].some(L)},$allElementsTrue:function(n,t){return ot(n,t)[0].every(L)}},Fn={$concat:function(n,t){var r=ot(n,t);return[null,void 0].some(q.bind(null,r))?null:r.join("")},$indexOfBytes:function(n,t){var r=ot(n,t),e="$indexOfBytes expression resolves to invalid an argument";if(T(r[0]))return null;x(A(r[0])&&A(r[1]),e);var u=r[0],i=r[1],o=r[2],a=r[3],s=T(o)||N(o)&&0<=o&&Math.round(o)===o;if(x(s=s&&(T(a)||N(a)&&0<=a&&Math.round(a)===a),e),o=o||0,(a=a||u.length)<o)return-1;var c=u.substring(o,a).indexOf(i);return-1<c?c+o:c},$split:function(n,t){var r=ot(n,t);return T(r[0])?null:(x(r.every(A),"$split expression must result to array(2) of strings"),r[0].split(r[1]))},$strLenBytes:function(n,t){return~-encodeURI(ot(n,t)).split(/%..|./).length},$strLenCP:function(n,t){return ot(n,t).length},$strcasecmp:function(n,t){var r=ot(n,t),e=r[0],u=r[1];return Q(e,u)||r.every(T)?0:(x(r.every(A),"$strcasecmp must resolve to array(2) of strings"),e=e.toUpperCase(),((u=u.toUpperCase())<e?1:e<u&&-1)||0)},$substrBytes:function(n,t){var r=ot(n,t),e=r[0],u=r[1],i=r[2];x(A(e)&&N(u)&&0<=u&&N(i)&&0<=i,"$substrBytes: invalid arguments");for(var o=function(n){for(var t=[],r=0,e=n.length;r<e;r++)t.push(Rn(n.codePointAt(r)));return t}(e),a=[],s=0,c=0;c<o.length;c++)a.push(s),s+=o[c].length;var f=a.indexOf(u),l=a.indexOf(u+i);return x(-1<f&&-1<l,"$substrBytes: invalid range, start or end index is a UTF-8 continuation byte."),e.substring(f,l)},$substr:function(n,t){var r=ot(n,t),e=r[0],u=r[1],i=r[2];return A(e)?u<0?"":i<0?e.substr(u):e.substr(u,i):""},$substrCP:function(n,t){return this.$substr(n,t)},$toLower:function(n,t){var r=ot(n,t);return R(r)?"":r.toLowerCase()},$toUpper:function(n,t){var r=ot(n,t);return R(r)?"":r.toUpperCase()}},Ln=[192,224,240];function Rn(n){if(n<128)return[n];for(var t=(n<2048?1:n<65536&&2)||3,r=[(n>>6*t)+Ln[t-1]];0<t;)r.push(128|n>>6*--t&63);return r}var Dn={$let:function(r,n){var e=n.vars,t=n.in;return V(z(e),function(n){var t=ot(r,e[n]);r["$"+n]=t}),ot(r,t)}},Un=Object.assign({},n,un,on,In,Pn,Tn,{$literal:function(n,t){return t}},qn,Fn,Dn);var Bn={$addToSet:function(n,t){return W(this.$push(n,t))},$avg:function(n,t){var r=this.$push(n,t).filter(N);return J(r,function(n,t){return n+t},0)/(r.length||1)},$first:function(n,t){return 0<n.length?ot(n[0],t):void 0},$last:function(n,t){return 0<n.length?ot(n[n.length-1],t):void 0},$mergeObjects:function(n,r){return J(n,function(n,t){return Object.assign(n,ot(t,r))},{})},$max:function(n,t){return J(this.$push(n,t),function(n,t){return T(n)||n<t?t:n},void 0)},$min:function(n,t){return J(this.$push(n,t),function(n,t){return T(n)||t<n?t:n},void 0)},$push:function(n,t){return T(t)?n:n.map(function(n){return ot(n,t)})},$stdDevPop:function(n,t){return st({data:this.$push(n,t).filter(N),sampled:!1})},$stdDevSamp:function(n,t){return st({data:this.$push(n,t).filter(N),sampled:!0})},$sum:function(n,t){return E(n)?N(t)?n.length*t:J(this.$push(n,t).filter(N),function(n,t){return n+t},0):0}},zn={expression:Un,group:Bn,pipeline:On,projection:xn,query:Sn};function Vn(){return J(Array.prototype.slice.call(arguments),function(n,t){return rn(n,z(zn[t]))},[])}var Yn={key:"_id"};var Jn={$$ROOT:function(n,t,r){return r.root},$$CURRENT:function(n){return n},$$REMOVE:function(){}},Hn={$$KEEP:function(n){return n},$$PRUNE:function(){},$$DESCEND:function(r,e,u){return U(e,"$cond")&&V(r,function(n,t){I(n)&&(E(n)?(i=[],V(n,function(n){S(n)&&(n=ct(n,e,u)),T(n)||i.push(n)})):i=ct(n,e,u),T(i)?delete r[t]:r[t]=i)}),r;var i}},Kn=z(Jn),Qn=z(Hn);function Wn(){return Yn.key}function Gn(n,t){return I(n)?n[t]:void 0}function Xn(r,n,e){if(q(Vn($),n))return Bn[n](r,e);if(S(e)){var u={};return V(e,function(n,t){if(u[t]=Xn(r,t,e[t]),q(Vn($),t))return u=u[t],x(1===z(e).length,"Invalid $group expression '"+JSON.stringify(e)+"'"),!1}),u}}function Zn(n,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},o=0;return r.meta=r.meta||!1,n=q(p,M(n))?n:function e(n,u){for(var t=n,r=0;r<u.length;r++){var i=u[r];if(null===i.match(/^\d+$/)&&E(t)){if(0===r&&0<o)break;o+=1,u=u.slice(r),t=J(t,function(n,t){var r=e(t,u);return void 0!==r&&n.push(r),n},[]);break}if(void 0===(t=Gn(t,i)))break}return t}(n,t.split(".")),r.meta?{result:n,depth:o}:n}function nt(n,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};r.preserveMissingValues=r.preserveMissingValues||!1;var e,u,i=t.split("."),o=i[0],a=1===i.length||i.slice(1).join("."),s=null!==o.match(/^\d+$/),c=1<i.length;try{E(n)?s?(e=Gn(n,Number(o)),c&&(e=nt(e,a,r)),e=[e]):(e=[],V(n,function(n){u=nt(n,t,r),r.preserveMissingValues?(void 0===u&&(u=b),e.push(u)):void 0!==u&&e.push(u)})):(u=Gn(n,o),c&&(u=nt(u,a,r)),x(void 0!==u),(e={})[o]=u)}catch(n){e=void 0}return e}function tt(n,t,r,e){var u=3<arguments.length&&void 0!==e&&e,i=t.split("."),o=i[0],a=1===i.length||i.slice(1).join(".");1===i.length?r(n,o):(!0===u&&T(n[o])&&(n[o]={}),tt(n[o],a,r,u))}function rt(n,t,r){tt(n,t,function(n,t){n[t]=r},!0)}function et(n,t){tt(n,t,function(n,t){E(n)&&/^\d+$/.test(t)?n.splice(parseInt(t),1):S(n)&&delete n[t]})}function ut(n){return!!n&&"$"===n[0]}function it(n){if(q(p,M(n)))return C(n)?{$regex:n}:{$eq:n};if(I(n)){var t=z(n);if(!t.some(ut))return{$eq:n};if(q(t,"$regex")){var r=n.$regex,e=n.$options||"",u="";A(r)&&(u+=r.ignoreCase||0<=e.indexOf("i")?"i":"",u+=r.multiline||0<=e.indexOf("m")?"m":"",u+=r.global||0<=e.indexOf("g")?"g":"",r=new RegExp(r,u)),n.$regex=r,delete n.$options}}return n}function ot(r,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,u=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};if(u.root=u.root||r,q(Vn(d),n))return Un[n](r,e,u);if(q(Vn($),n))return r=ot(r,e,null,u),x(E(r),n+" expression must resolve to an array"),Bn[n](r,null,u);if(A(e)&&0<e.length&&"$"===e[0]){if(q(Kn,e))return Jn[e](r,null,u);if(q(Qn,e))return e;var t=Kn.filter(function(n){return 0===e.indexOf(n+".")});return 1===t.length&&("$$ROOT"===(t=t[0])&&(r=u.root),e=e.substr(t.length)),Zn(r,e.slice(1))}switch(M(e)){case l:return e.map(function(n){return ot(r,n)});case v:var i={};return V(e,function(n,t){if(i[t]=ot(r,n,t,u),q(Vn(d,$),t))return x(1===z(e).length,"Invalid aggregation expression '"+JSON.stringify(e)+"'"),i=i[t],!1}),i;default:return e}}function at(n,t,r){var e=2<arguments.length&&void 0!==r?r:null;return T(e)?t<0?(t=Math.max(0,n.length+t),e=n.length-t+1):(e=t,t=0):(t<0&&(t=Math.max(0,n.length+t)),x(0<e,"Invalid argument value for $slice operator. Limit must be a positive number"),e+=t),n.slice(t,e)}function st(n){var t=J(n.data,function(n,t){return n+t},0),r=n.data.length||1,e=n.sampled?1:0,u=t/r;return Math.sqrt(J(n.data,function(n,t){return n+Math.pow(t-u,2)},0)/(r-e))}function ct(n,t,r){var e=2<arguments.length&&void 0!==r?r:{};e.root=e.root||n;var u=ot(n,t,null,e);return q(Qn,u)?Hn[u](n,t,e):u}function ft(){return{assert:x,computeValue:ot,clone:O,cloneDeep:k,each:V,err:B,hashCode:X,getType:w,has:U,idKey:Wn,includes:q.bind(null),isArray:E,isBoolean:j,isDate:P,isEmpty:R,isEqual:Q,isFunction:r,isNil:T,isNull:e,isNumber:N,isObject:S,isRegExp:C,isString:A,isUndefined:t,keys:z,ops:Vn,resolve:Zn,resolveObj:nt,reduce:J}}var lt={query:function(n,t){return new An(n).find(this.toJSON(),t)},aggregate:function(n){return new wn(n).run(this.toJSON())}};return{_internal:ft,Aggregator:wn,CollectionMixin:lt,Cursor:jn,Lazy:vn,OP_EXPRESSION:d,OP_GROUP:$,OP_PIPELINE:g,OP_PROJECTION:m,OP_QUERY:y,Query:An,VERSION:"2.4.0",addOperators:function(r,n){var a=n(ft());x(U(zn,r),"Invalid operator class ".concat(r));var e=zn[r];V(a,function(n,t){x(/^\$\w+$/.test(t),"Invalid operator name ".concat(t)),x(!U(e,t),"".concat(t," already exists for '").concat(r,"' operators"))});var t={};switch(r){case y:V(a,function(i,o){i=i.bind(a),t[o]=function(e,u){return{test:function(n){var t=Zn(n,e),r=i(e,t,u);return x(j(r),"".concat(o," must return a boolean")),r}}}});break;case m:V(a,function(u,n){u=u.bind(a),t[n]=function(n,t,r){var e=Zn(n,r);return u(r,e,t)}});break;default:V(a,function(e,n){t[n]=function(){for(var n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];return e.apply(a,t)}})}Object.assign(zn[r],t)},aggregate:Mn,find:function(n,t,r){return new An(t).find(n,r)},remove:function(n,t){return new An(t).remove(n)},setup:function(n){Object.assign(Yn,n||{})}}});
//# sourceMappingURL=dist/mingo.min.js.map