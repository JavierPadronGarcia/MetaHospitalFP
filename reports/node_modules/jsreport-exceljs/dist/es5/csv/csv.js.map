{"version":3,"file":"csv.js","names":["fs","require","fastCsv","customParseFormat","dayjs","extend","StreamBuf","exists","SpecialValues","true","false","error","CSV","workbook","worksheet","filename","options","Error","stream","createReadStream","read","close","Promise","resolve","reject","csvStream","createInputStream","on","pipe","addWorksheet","sheetName","dateFormats","map","datum","datumNumber","Number","isNaN","Infinity","dt","reduce","matchingDate","currentDateFormat","dayjsObj","isValid","Date","valueOf","special","undefined","parse","data","addRow","emit","getWorksheet","sheetId","format","dateFormat","dateUTC","value","text","hyperlink","formula","result","utc","JSON","stringify","includeEmptyRows","lastRow","eachRow","row","rowNumber","write","values","shift","end","streamOptions","encoding","createWriteStream","module","exports"],"sources":["../../../lib/csv/csv.js"],"sourcesContent":["const fs = require('fs');\nconst fastCsv = require('fast-csv');\nconst customParseFormat = require('dayjs/plugin/customParseFormat');\nconst dayjs = require('dayjs').extend(customParseFormat);\nconst StreamBuf = require('../utils/stream-buf');\n\nconst {fs: {exists}} = require('../utils/utils');\n\n/* eslint-disable quote-props */\nconst SpecialValues = {\n  true: true,\n  false: false,\n  '#N/A': {error: '#N/A'},\n  '#REF!': {error: '#REF!'},\n  '#NAME?': {error: '#NAME?'},\n  '#DIV/0!': {error: '#DIV/0!'},\n  '#NULL!': {error: '#NULL!'},\n  '#VALUE!': {error: '#VALUE!'},\n  '#NUM!': {error: '#NUM!'},\n};\n/* eslint-ensable quote-props */\n\nclass CSV {\n  constructor(workbook) {\n    this.workbook = workbook;\n    this.worksheet = null;\n  }\n\n  async readFile(filename, options) {\n    options = options || {};\n    if (!(await exists(filename))) {\n      throw new Error(`File not found: ${filename}`);\n    }\n    const stream = fs.createReadStream(filename);\n    const worksheet = await this.read(stream, options);\n    stream.close();\n    return worksheet;\n  }\n\n  read(stream, options) {\n    options = options || {};\n    return new Promise((resolve, reject) => {\n      const csvStream = this.createInputStream(options)\n        .on('worksheet', resolve)\n        .on('error', reject);\n\n      stream.pipe(csvStream);\n    });\n  }\n\n  createInputStream(options) {\n    options = options || {};\n    const worksheet = this.workbook.addWorksheet(options.sheetName);\n\n    const dateFormats = options.dateFormats || ['YYYY-MM-DD[T]HH:mm:ss', 'MM-DD-YYYY', 'YYYY-MM-DD'];\n    const map =\n      options.map ||\n      function(datum) {\n        if (datum === '') {\n          return null;\n        }\n        const datumNumber = Number(datum);\n        if (!Number.isNaN(datumNumber) && datumNumber !== Infinity) {\n          return datumNumber;\n        }\n        const dt = dateFormats.reduce((matchingDate, currentDateFormat) => {\n          if (matchingDate) {\n            return matchingDate;\n          }\n          const dayjsObj = dayjs(datum, currentDateFormat, true);\n          if (dayjsObj.isValid()) {\n            return dayjsObj;\n          }\n          return null;\n        }, null);\n        if (dt) {\n          return new Date(dt.valueOf());\n        }\n        const special = SpecialValues[datum];\n        if (special !== undefined) {\n          return special;\n        }\n        return datum;\n      };\n\n    const csvStream = fastCsv.parse(options)\n      .on('data', data => {\n        worksheet.addRow(data.map(map));\n      })\n      .on('end', () => {\n        csvStream.emit('worksheet', worksheet);\n      });\n    return csvStream;\n  }\n\n  write(stream, options) {\n    return new Promise((resolve, reject) => {\n      options = options || {};\n      // const encoding = options.encoding || 'utf8';\n      // const separator = options.separator || ',';\n      // const quoteChar = options.quoteChar || '\\'';\n\n      const worksheet = this.workbook.getWorksheet(options.sheetName || options.sheetId);\n\n      const csvStream = fastCsv.format(options);\n      stream.on('finish', () => {\n        resolve();\n      });\n      csvStream.on('error', reject);\n      csvStream.pipe(stream);\n\n      const {dateFormat, dateUTC} = options;\n      const map =\n        options.map ||\n        (value => {\n          if (value) {\n            if (value.text || value.hyperlink) {\n              return value.hyperlink || value.text || '';\n            }\n            if (value.formula || value.result) {\n              return value.result || '';\n            }\n            if (value instanceof Date) {\n              if (dateFormat) {\n                return dateUTC ? dayjs.utc(value).format(dateFormat) : dayjs(value).format(dateFormat);\n              }\n              return dateUTC ? dayjs.utc(value).format() : dayjs(value).format();\n            }\n            if (value.error) {\n              return value.error;\n            }\n            if (typeof value === 'object') {\n              return JSON.stringify(value);\n            }\n          }\n          return value;\n        });\n\n      const includeEmptyRows = options.includeEmptyRows === undefined || options.includeEmptyRows;\n      let lastRow = 1;\n      if (worksheet) {\n        worksheet.eachRow((row, rowNumber) => {\n          if (includeEmptyRows) {\n            while (lastRow++ < rowNumber - 1) {\n              csvStream.write([]);\n            }\n          }\n          const {values} = row;\n          values.shift();\n          csvStream.write(values.map(map));\n          lastRow = rowNumber;\n        });\n      }\n      csvStream.end();\n    });\n  }\n\n  writeFile(filename, options) {\n    options = options || {};\n\n    const streamOptions = {\n      encoding: options.encoding || 'utf8',\n    };\n    const stream = fs.createWriteStream(filename, streamOptions);\n\n    return this.write(stream, options);\n  }\n\n  async writeBuffer(options) {\n    const stream = new StreamBuf();\n    await this.write(stream, options);\n    return stream.read();\n  }\n}\n\nmodule.exports = CSV;\n"],"mappings":"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"}