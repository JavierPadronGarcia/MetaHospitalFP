{"version":3,"file":"workbook-writer.js","names":["require","StringDecoder","fs","Transform","DOMParser","Archiver","unzip","streamifier","tmp","StreamBuf","RelType","StylesXform","SharedStrings","DefinedNames","CoreXform","RelationshipsXform","ContentTypesXform","AppXform","WorkbookXform","SharedStringsXform","WorksheetWriter","theme1Xml","WorkbookWriter","options","created","Date","modified","creator","lastModifiedBy","lastPrinted","useSharedStrings","sharedStrings","template","styles","useStyles","Mock","_definedNames","_worksheets","_tmpWorksheets","Map","_cellStylesCache","views","zipOptions","zip","media","commentRefs","templateBuf","templateWrites","templateInfo","templateZip","Parse","stream","filename","createWriteStream","pipe","promise","Promise","resolve","all","addThemes","addOfficeRels","name","id","existingWorkSheet","sheets","find","s","sheetFileId","nextId","path","sheetId","bufSize","batch","isWorksheet","has","tmpWorksheet","get","zipEntryPath","tmpWriteStream","tmpPath","waitComplete","reject","on","append","emit","commitWorksheet","worksheet","committed","commit","promises","map","length","templateStream","createReadStream","files","pendingOperations","waitingWorkSheets","entry","push","parseXMLFile","match","_resolve","_reject","file","err","tmpFilePath","tempStream","ref","filesDocuments","workbookDoc","doc","relsDoc","Array","from","getElementsByTagName","sheetNode","parseInt","getAttribute","rId","targetRNode","rNode","sheetFile","sheetFileFound","w","lastSheetId","lastSheetFileId","sheetFileSrc","parseStream","originalSrc","lastWorkbookRelsId","reduce","acu","relNode","rIdNumber","addMedia","newWorksheets","newWorksheetsColsWidth","forEach","isArray","_columns","set","c","number","_number","width","replacedWorksheets","sheet","existingWorksheetIndex","findIndex","replaced","calcCells","_calcCells","splice","filter","_commitWorksheets","fileName","fileDoc","content","sheetNodeRef","node","newWorksheet","newWorkSheetRef","cloneNode","setAttribute","parentNode","insertBefore","nextSibling","toString","xml","sheetsNode","i","newSheetNode","createElement","appendChild","relationshipsNode","newRelNode","calcChainNode","cellRefNodes","existingCalcCells","cellRefNode","worksheetIndex","cellRef","replacedWorksheetFound","removeChild","replacedWorksheet","calcCellsInWorksheet","Object","entries","cellAddress","newCellRef","addContentTypes","addApp","addCore","addSharedStrings","addStyles","addWorkbookRels","addWorkbook","tmpWorksheetCompletePromises","value","worksheetsToCopy","worksheetStream","decoder","placeholderFound","distStream","transform","chunk","enc","cb","chunkStr","write","includes","colsXML","rawColsXML","slice","replace","flush","str","end","_finalize","result","existingSheetsId","existingSheets","values","o","image","assign","type","undefined","tabColor","console","trace","properties","_getNextWorksheetId","workbook","state","pageSetup","autoFilter","addWorksheet","xform","toXml","Id","Type","OfficeDocument","Target","CoreProperties","ExtenderProperties","model","worksheets","Boolean","medium","idx","extension","buffer","base64","dataimg64","substring","indexOf","Error","coreXform","count","sharedStringsXform","relationships","Styles","Theme","Worksheet","definedNames","calcProperties","prepare","finalize","parseFromString","module","exports"],"sources":["../../../../lib/stream/xlsx/workbook-writer.js"],"sourcesContent":["const {StringDecoder} = require('string_decoder');\nconst fs = require('fs');\nconst {Transform} = require('stream');\nconst {DOMParser} = require('@xmldom/xmldom');\nconst Archiver = require('archiver');\nconst unzip = require('unzipper');\nconst streamifier = require('streamifier');\nconst tmp = require('tmp');\nconst StreamBuf = require('../../utils/stream-buf');\nconst RelType = require('../../xlsx/rel-type');\nconst StylesXform = require('../../xlsx/xform/style/styles-xform');\nconst SharedStrings = require('../../utils/shared-strings');\nconst DefinedNames = require('../../doc/defined-names');\n\nconst CoreXform = require('../../xlsx/xform/core/core-xform');\nconst RelationshipsXform = require('../../xlsx/xform/core/relationships-xform');\nconst ContentTypesXform = require('../../xlsx/xform/core/content-types-xform');\nconst AppXform = require('../../xlsx/xform/core/app-xform');\nconst WorkbookXform = require('../../xlsx/xform/book/workbook-xform');\nconst SharedStringsXform = require('../../xlsx/xform/strings/shared-strings-xform');\n\nconst WorksheetWriter = require('./worksheet-writer');\n\nconst theme1Xml = require('../../xlsx/xml/theme1.js');\n\nclass WorkbookWriter {\n  constructor(options) {\n    options = options || {};\n\n    this.created = options.created || new Date();\n    this.modified = options.modified || this.created;\n    this.creator = options.creator || 'ExcelJS';\n    this.lastModifiedBy = options.lastModifiedBy || 'ExcelJS';\n    this.lastPrinted = options.lastPrinted;\n\n    // using shared strings creates a smaller xlsx file but may use more memory\n    this.useSharedStrings = options.useSharedStrings || false;\n    this.sharedStrings = new SharedStrings();\n\n    // style manager\n    if (options.template) {\n      this.styles = new StylesXform(true);\n    } else {\n      this.styles = options.useStyles ? new StylesXform(true) : new StylesXform.Mock(true);\n    }\n\n    // defined names\n    this._definedNames = new DefinedNames();\n\n    this._worksheets = [];\n\n    this._tmpWorksheets = new Map();\n\n    this._cellStylesCache = new Map();\n\n    this.views = [];\n\n    this.zipOptions = options.zip;\n\n    this.media = [];\n    this.commentRefs = [];\n\n    if (options.template) {\n      this.templateBuf = options.template;\n      this.templateWrites = [];\n      this.templateInfo = {};\n      this.templateZip = unzip.Parse();\n    }\n\n    this.zip = Archiver('zip', this.zipOptions);\n    if (options.stream) {\n      this.stream = options.stream;\n    } else if (options.filename) {\n      this.stream = fs.createWriteStream(options.filename);\n    } else {\n      this.stream = new StreamBuf();\n    }\n    this.zip.pipe(this.stream);\n\n    if (options.template) {\n      this.promise = new Promise((resolve) => resolve());\n    } else {\n      // these bits can be added right now\n      this.promise = Promise.all([this.addThemes(), this.addOfficeRels()]);\n    }\n  }\n\n  get definedNames() {\n    return this._definedNames;\n  }\n\n  _getNextWorksheetId(name) {\n    let id;\n\n    if (this.templateInfo) {\n      const existingWorkSheet = this.templateInfo.sheets.find((s) => s.name === name);\n\n      if (existingWorkSheet) {\n        id = existingWorkSheet.sheetFileId;\n      } else {\n        id = this.nextId;\n      }\n    } else {\n      id = this.nextId;\n    }\n\n    return id;\n  }\n\n  _openStream(path, sheetId) {\n    const stream = new StreamBuf({bufSize: 65536, batch: true});\n    const isWorksheet = sheetId != null;\n\n    if (isWorksheet && this._tmpWorksheets.has(sheetId)) {\n      const tmpWorksheet = this._tmpWorksheets.get(sheetId);\n      tmpWorksheet.zipEntryPath = path;\n\n      const tmpWriteStream = fs.createWriteStream(tmpWorksheet.tmpPath);\n\n      tmpWorksheet.waitComplete = new Promise((resolve, reject) => {\n        tmpWriteStream.on('error', reject);\n        tmpWriteStream.on('finish', resolve);\n      });\n\n      stream.pipe(tmpWriteStream);\n    } else {\n      this.zip.append(stream, {name: path});\n    }\n\n    stream.on('finish', () => {\n      stream.emit('zipped');\n    });\n    return stream;\n  }\n\n  _commitWorksheets() {\n    const commitWorksheet = function(worksheet) {\n      if (!worksheet.committed) {\n        return new Promise(resolve => {\n          worksheet.stream.on('zipped', () => {\n            resolve();\n          });\n          worksheet.commit();\n        });\n      }\n      return Promise.resolve();\n    };\n    // if there are any uncommitted worksheets, commit them now and wait\n    const promises = this._worksheets.map(commitWorksheet);\n    if (promises.length) {\n      return Promise.all(promises);\n    }\n    return Promise.resolve();\n  }\n\n  async waitForTemplateParse() {\n    const templateStream = streamifier.createReadStream(this.templateBuf);\n    const files = {};\n    const pendingOperations = [];\n    const waitingWorkSheets = [];\n\n    await new Promise((resolve, reject) => {\n      this.templateZip.on('entry', (entry) => {\n        switch (entry.path) {\n          case '[Content_Types].xml':\n          case 'xl/styles.xml':\n          case 'xl/workbook.xml':\n          case 'xl/_rels/workbook.xml.rels':\n          case 'xl/calcChain.xml':\n            pendingOperations.push(parseXMLFile(files, entry));\n            break;\n          default:\n            if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\n              pendingOperations.push(new Promise((_resolve, _reject) => {\n                // eslint-disable-next-line consistent-return\n                tmp.file((err, tmpFilePath) => {\n                  if (err) { return reject(err); }\n\n                  const tempStream = fs.createWriteStream(tmpFilePath);\n\n                  waitingWorkSheets.push({\n                    ref: entry.path,\n                    path: tmpFilePath,\n                  });\n\n                  entry.on('error', _reject);\n                  tempStream.on('error', _reject);\n                  tempStream.on('finish', _resolve);\n\n                  entry.pipe(tempStream);\n                });\n              }));\n            } else {\n              this.templateWrites.push(new Promise(_resolve => {\n                this.zip.append(entry, {name: entry.path});\n                _resolve();\n              }));\n            }\n            break;\n        }\n      });\n\n      this.templateZip.on('close', () => {\n        resolve();\n      });\n\n      this.templateZip.on('error', reject);\n\n      templateStream.pipe(this.templateZip);\n    });\n\n    await Promise.all(pendingOperations);\n\n    this.templateInfo.filesDocuments = files;\n\n    const workbookDoc = this.templateInfo.filesDocuments['xl/workbook.xml'].doc;\n    const relsDoc = this.templateInfo.filesDocuments['xl/_rels/workbook.xml.rels'].doc;\n\n    let lastSheetId;\n    let lastSheetFileId;\n\n    const sheets = Array.from(workbookDoc.getElementsByTagName('sheet')).map((sheetNode) => {\n      const sheetId = parseInt(sheetNode.getAttribute('sheetId'), 10);\n      const rId = sheetNode.getAttribute('r:id');\n      const targetRNode = Array.from(relsDoc.getElementsByTagName('Relationship')).find((rNode) => rNode.getAttribute('Id') === rId);\n      const sheetFile = targetRNode.getAttribute('Target');\n      const sheetFileId = parseInt(sheetFile.match(/worksheets\\/sheet(\\d+)[.]xml/)[1], 10);\n      const sheetFileFound = waitingWorkSheets.find((w) => w.ref === `xl/worksheets/sheet${sheetFileId}.xml`);\n\n      if (lastSheetId == null || lastSheetId < sheetId) {\n        lastSheetId = sheetId;\n      }\n\n      if (lastSheetFileId == null || lastSheetFileId < sheetFileId) {\n        lastSheetFileId = sheetFileId;\n      }\n\n      return {\n        id: sheetId,\n        name: sheetNode.getAttribute('name'),\n        rId,\n        sheetFile,\n        sheetFileId,\n        sheetFileSrc: {\n          path: sheetFileFound.path,\n        },\n      };\n    });\n\n    // take existing styles from template as the base of new styles\n    await this.styles.parseStream(\n      streamifier.createReadStream(this.templateInfo.filesDocuments['xl/styles.xml'].originalSrc)\n    );\n\n    const lastWorkbookRelsId = Array.from(\n      relsDoc.getElementsByTagName('Relationship')\n    ).reduce((acu, relNode) => {\n      const rId = relNode.getAttribute('Id');\n      const rIdNumber = parseInt(rId.match(/rId(\\d+)/)[1], 10);\n\n      if (rIdNumber > acu) {\n        return rIdNumber;\n      }\n\n      return acu;\n    }, 0);\n\n    this.templateInfo.sheets = sheets;\n    this.templateInfo.lastSheetId = lastSheetId;\n    this.templateInfo.lastSheetFileId = lastSheetFileId;\n    this.templateInfo.lastWorkbookRelsId = lastWorkbookRelsId;\n  }\n\n  async commit() {\n    // commit all worksheets, then add suplimentary files\n    await this.promise;\n\n    if (this.templateWrites) {\n      await Promise.all(this.templateWrites);\n    }\n\n    await this.addMedia();\n\n    const newWorksheets = [];\n    const newWorksheetsColsWidth = new Map();\n\n    this._worksheets.forEach((w) => {\n      if (w == null) {\n        return;\n      }\n\n      // eslint-disable-next-line no-underscore-dangle\n      if (Array.isArray(w._columns)) {\n        // eslint-disable-next-line no-underscore-dangle\n        newWorksheetsColsWidth.set(w.id, w._columns.map((c) => {\n          return {\n            // eslint-disable-next-line no-underscore-dangle\n            number: c._number,\n            width: c.width,\n          };\n        }));\n      }\n\n      newWorksheets.push(w);\n    });\n\n    let replacedWorksheets = [];\n\n    if (this.templateInfo) {\n      this.templateInfo.sheets.forEach((sheet) => {\n        const existingWorksheetIndex = newWorksheets.findIndex((w) => w.name === sheet.name);\n\n        if (existingWorksheetIndex !== -1) {\n          sheet.replaced = true;\n          // eslint-disable-next-line no-underscore-dangle\n          sheet.calcCells = newWorksheets[existingWorksheetIndex]._calcCells;\n          newWorksheets.splice(existingWorksheetIndex, 1);\n          return;\n        }\n\n        this.zip.append(fs.createReadStream(sheet.sheetFileSrc.path), {\n          name: `xl/worksheets/sheet${sheet.sheetFileId}.xml`,\n        });\n      });\n\n      replacedWorksheets = this.templateInfo.sheets.filter(s => s.replaced === true);\n    }\n\n    await this._commitWorksheets();\n\n    if (this.templateInfo) {\n      // eslint-disable-next-line no-restricted-syntax\n      for (const [fileName, {doc: fileDoc, originalSrc}] of Object.entries(this.templateInfo.filesDocuments)) {\n        let content = originalSrc;\n\n        if (fileName === '[Content_Types].xml' && newWorksheets.length > 0) {\n          const sheetNodeRef = Array.from(\n            fileDoc.getElementsByTagName('Override')\n          ).find((node) => {\n            return node.getAttribute('PartName') === `/xl/worksheets/sheet${this.templateInfo.lastSheetFileId}.xml`;\n          });\n\n          // eslint-disable-next-line no-restricted-syntax\n          for (const newWorksheet of newWorksheets) {\n            const newWorkSheetRef = sheetNodeRef.cloneNode();\n            newWorkSheetRef.setAttribute('PartName', `/xl/worksheets/sheet${newWorksheet.id}.xml`);\n            sheetNodeRef.parentNode.insertBefore(newWorkSheetRef, sheetNodeRef.nextSibling);\n          }\n\n          content = fileDoc.toString();\n        } else if (fileName === 'xl/styles.xml') {\n          content = this.styles.xml;\n        } else if (fileName === 'xl/workbook.xml' && newWorksheets.length > 0) {\n          const sheetsNode = fileDoc.getElementsByTagName('sheets')[0];\n\n          for (let i = 0; i < newWorksheets.length; i++) {\n            const newWorksheet = newWorksheets[i];\n            const newSheetNode = fileDoc.createElement('sheet');\n            newSheetNode.setAttribute('name', newWorksheet.name);\n            newSheetNode.setAttribute('sheetId', this.templateInfo.lastSheetId + i + 1);\n            newSheetNode.setAttribute('r:id', `rId${this.templateInfo.lastWorkbookRelsId + i + 1}`);\n            sheetsNode.appendChild(newSheetNode);\n          }\n\n          content = fileDoc.toString();\n        } else if (fileName === 'xl/_rels/workbook.xml.rels' && newWorksheets.length > 0) {\n          const relationshipsNode = fileDoc.getElementsByTagName('Relationships')[0];\n\n          for (let i = 0; i < newWorksheets.length; i++) {\n            const newWorksheet = newWorksheets[i];\n            const newRelNode = fileDoc.createElement('Relationship');\n            newRelNode.setAttribute('Id', `rId${this.templateInfo.lastWorkbookRelsId + i + 1}`);\n            newRelNode.setAttribute('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet');\n            newRelNode.setAttribute('Target', `worksheets/sheet${newWorksheet.id}.xml`);\n            relationshipsNode.appendChild(newRelNode);\n          }\n\n          content = fileDoc.toString();\n        } else if (fileName === 'xl/calcChain.xml' && replacedWorksheets.length > 0) {\n          const calcChainNode = fileDoc.getElementsByTagName('calcChain')[0];\n          const cellRefNodes = Array.from(fileDoc.getElementsByTagName('c'));\n\n          const existingCalcCells = {};\n\n          cellRefNodes.forEach((cellRefNode) => {\n            const worksheetIndex = parseInt(cellRefNode.getAttribute('i'), 10);\n            const cellRef = cellRefNode.getAttribute('r');\n            const replacedWorksheetFound = replacedWorksheets.find(w => w.id === worksheetIndex);\n\n            if (!replacedWorksheetFound) {\n              return;\n            }\n\n            if (!replacedWorksheetFound.calcCells[cellRef]) {\n              cellRefNode.parentNode.removeChild(cellRefNode);\n            } else {\n              existingCalcCells[worksheetIndex] = existingCalcCells[worksheetIndex] || {};\n              existingCalcCells[worksheetIndex][cellRef] = true;\n            }\n          });\n\n          replacedWorksheets.forEach((replacedWorksheet) => {\n            const calcCellsInWorksheet = existingCalcCells[replacedWorksheet.id] || {};\n\n            // eslint-disable-next-line no-restricted-syntax\n            for (const [cellAddress] of Object.entries(replacedWorksheet.calcCells)) {\n              if (!calcCellsInWorksheet[cellAddress]) {\n                const newCellRef = fileDoc.createElement('c');\n                newCellRef.setAttribute('r', cellAddress);\n                newCellRef.setAttribute('i', replacedWorksheet.id);\n                calcChainNode.appendChild(newCellRef);\n              }\n            }\n          });\n\n          content = fileDoc.toString();\n        }\n\n        this.zip.append(content, {\n          name: fileName,\n        });\n      }\n    } else {\n      await Promise.all([\n        this.addContentTypes(),\n        this.addApp(),\n        this.addCore(),\n        this.addSharedStrings(),\n        this.addStyles(),\n        this.addWorkbookRels(),\n      ]);\n\n      await this.addWorkbook();\n    }\n\n    const tmpWorksheetCompletePromises = [];\n\n    this._tmpWorksheets.forEach((value) => {\n      tmpWorksheetCompletePromises.push(value.waitComplete);\n    });\n\n    await Promise.all(tmpWorksheetCompletePromises);\n\n    const worksheetsToCopy = [];\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const [sheetId, tmpWorksheet] of this._tmpWorksheets.entries()) {\n      worksheetsToCopy.push({\n        sheetId,\n        tmpWorksheet,\n      });\n    }\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const w of worksheetsToCopy) {\n      const {sheetId, tmpWorksheet} = w;\n\n      // eslint-disable-next-line no-await-in-loop\n      await new Promise((resolve, reject) => {\n        const worksheetStream = fs.createReadStream(tmpWorksheet.tmpPath);\n        const decoder = new StringDecoder('utf8');\n        let placeholderFound = false;\n\n        const distStream = new Transform({\n          transform: (chunk, enc, cb) => {\n            const chunkStr = decoder.write(chunk);\n\n            if (!placeholderFound && chunkStr.includes('$colsContent')) {\n              placeholderFound = true;\n              let colsXML = this._worksheets[sheetId].rawColsXML;\n\n              colsXML = colsXML.slice('<cols>'.length).slice(0, '</cols>'.length * -1);\n\n              cb(null, chunkStr.replace('$colsContent', colsXML));\n            } else {\n              cb(null, chunkStr);\n            }\n          },\n          flush: (cb) => {\n            const str = decoder.end();\n\n            if (str !== '') {\n              cb(null, str);\n            } else {\n              cb();\n            }\n          },\n        });\n\n        distStream.on('finish', resolve);\n        worksheetStream.on('error', reject);\n        distStream.on('error', reject);\n\n        this.zip.append(distStream, {\n          name: tmpWorksheet.zipEntryPath,\n        });\n\n        worksheetStream.pipe(distStream);\n      });\n    }\n\n    const result = await this._finalize();\n\n    return result;\n  }\n\n  get nextId() {\n    let id;\n    // find the next unique spot to add worksheet\n    let i;\n\n    if (this.templateInfo && this.templateInfo.lastSheetFileId != null) {\n      const existingSheetsId = this.templateInfo.sheets.map((s) => s.sheetFileId);\n\n      const existingSheets = Object.values(this._worksheets).filter((o) => {\n        return existingSheetsId.includes(o.id) === false;\n      });\n\n      return this.templateInfo.lastSheetFileId + existingSheets.length + 1;\n    }\n\n    for (i = 1; i < this._worksheets.length; i++) {\n      if (!this._worksheets[i]) {\n        id = i;\n        break;\n      }\n    }\n\n    if (id == null) {\n      id = this._worksheets.length || 1;\n    }\n\n    return id;\n  }\n\n  addImage(image) {\n    const id = this.media.length;\n    this.media.push(Object.assign({}, image, {type: 'image'}));\n    return id;\n  }\n\n  getImage(id) {\n    return this.media[id];\n  }\n\n  addWorksheet(name, options) {\n    // it's possible to add a worksheet with different than default\n    // shared string handling\n    // in fact, it's even possible to switch it mid-sheet\n    options = options || {};\n    const useSharedStrings = options.useSharedStrings !== undefined ? options.useSharedStrings : this.useSharedStrings;\n\n    if (options.tabColor) {\n      // eslint-disable-next-line no-console\n      console.trace('tabColor option has moved to { properties: tabColor: {...} }');\n      options.properties = Object.assign(\n        {\n          tabColor: options.tabColor,\n        },\n        options.properties\n      );\n    }\n\n    let id;\n\n    if (options.id) {\n      // eslint-disable-next-line prefer-destructuring\n      id = options.id;\n      delete options.id;\n    } else {\n      id = this._getNextWorksheetId(name);\n    }\n\n    name = name || `sheet${id}`;\n\n    const worksheet = new WorksheetWriter({\n      id,\n      name,\n      workbook: this,\n      useSharedStrings,\n      properties: options.properties,\n      state: options.state,\n      pageSetup: options.pageSetup,\n      views: options.views,\n      autoFilter: options.autoFilter,\n    });\n\n    this._worksheets[id] = worksheet;\n    return worksheet;\n  }\n\n  async addWorksheetAsync(name, options) {\n    const id = this._getNextWorksheetId(name);\n\n    const tmpPath = await new Promise((resolve, reject) => {\n      // eslint-disable-next-line consistent-return\n      tmp.file((err, tmpFilePath) => {\n        if (err) { return reject(err); }\n        resolve(tmpFilePath);\n      });\n    });\n\n    this._tmpWorksheets.set(id, {\n      tmpPath,\n    });\n\n    return this.addWorksheet(name, {\n      ...options,\n      id,\n    });\n  }\n\n  getWorksheet(id) {\n    if (id === undefined) {\n      return this._worksheets.find(() => true);\n    }\n    if (typeof id === 'number') {\n      return this._worksheets[id];\n    }\n    if (typeof id === 'string') {\n      return this._worksheets.find(worksheet => worksheet && worksheet.name === id);\n    }\n    return undefined;\n  }\n\n  addStyles() {\n    return new Promise(resolve => {\n      this.zip.append(this.styles.xml, {name: 'xl/styles.xml'});\n      resolve();\n    });\n  }\n\n  addThemes() {\n    return new Promise(resolve => {\n      this.zip.append(theme1Xml, {name: 'xl/theme/theme1.xml'});\n      resolve();\n    });\n  }\n\n  addOfficeRels() {\n    return new Promise(resolve => {\n      const xform = new RelationshipsXform();\n      const xml = xform.toXml([\n        {Id: 'rId1', Type: RelType.OfficeDocument, Target: 'xl/workbook.xml'},\n        {Id: 'rId2', Type: RelType.CoreProperties, Target: 'docProps/core.xml'},\n        {Id: 'rId3', Type: RelType.ExtenderProperties, Target: 'docProps/app.xml'},\n      ]);\n      this.zip.append(xml, {name: '/_rels/.rels'});\n      resolve();\n    });\n  }\n\n  addContentTypes() {\n    return new Promise(resolve => {\n      const model = {\n        worksheets: this._worksheets.filter(Boolean),\n        sharedStrings: this.sharedStrings,\n        commentRefs: this.commentRefs,\n        media: this.media,\n      };\n      const xform = new ContentTypesXform();\n      const xml = xform.toXml(model);\n      this.zip.append(xml, {name: '[Content_Types].xml'});\n      resolve();\n    });\n  }\n\n  addMedia() {\n    return Promise.all(\n      this.media.map((medium, idx) => {\n        medium.name = `image${idx+1}.${medium.extension}`;\n        if (medium.type === 'image') {\n          const filename = `xl/media/${medium.name}`;\n          if (medium.filename) {\n            return this.zip.file(medium.filename, {name: filename});\n          }\n          if (medium.buffer) {\n            return this.zip.append(medium.buffer, {name: filename});\n          }\n          if (medium.base64) {\n            const dataimg64 = medium.base64;\n            const content = dataimg64.substring(dataimg64.indexOf(',') + 1);\n            return this.zip.append(content, {name: filename, base64: true});\n          }\n        }\n        throw new Error('Unsupported media');\n      })\n    );\n  }\n\n  addApp() {\n    return new Promise(resolve => {\n      const model = {\n        worksheets: this._worksheets.filter(Boolean),\n      };\n      const xform = new AppXform();\n      const xml = xform.toXml(model);\n      this.zip.append(xml, {name: 'docProps/app.xml'});\n      resolve();\n    });\n  }\n\n  addCore() {\n    return new Promise(resolve => {\n      const coreXform = new CoreXform();\n      const xml = coreXform.toXml(this);\n      this.zip.append(xml, {name: 'docProps/core.xml'});\n      resolve();\n    });\n  }\n\n  addSharedStrings() {\n    if (this.sharedStrings.count) {\n      return new Promise(resolve => {\n        const sharedStringsXform = new SharedStringsXform();\n        const xml = sharedStringsXform.toXml(this.sharedStrings);\n        this.zip.append(xml, {name: '/xl/sharedStrings.xml'});\n        resolve();\n      });\n    }\n    return Promise.resolve();\n  }\n\n  addWorkbookRels() {\n    let count = 1;\n    const relationships = [\n      {Id: `rId${count++}`, Type: RelType.Styles, Target: 'styles.xml'},\n      {Id: `rId${count++}`, Type: RelType.Theme, Target: 'theme/theme1.xml'},\n    ];\n    if (this.sharedStrings.count) {\n      relationships.push({Id: `rId${count++}`, Type: RelType.SharedStrings, Target: 'sharedStrings.xml'});\n    }\n    this._worksheets.forEach(worksheet => {\n      if (worksheet) {\n        worksheet.rId = `rId${count++}`;\n        relationships.push({Id: worksheet.rId, Type: RelType.Worksheet, Target: `worksheets/sheet${worksheet.id}.xml`});\n      }\n    });\n    return new Promise(resolve => {\n      const xform = new RelationshipsXform();\n      const xml = xform.toXml(relationships);\n      this.zip.append(xml, {name: '/xl/_rels/workbook.xml.rels'});\n      resolve();\n    });\n  }\n\n  addWorkbook() {\n    const {zip} = this;\n    const model = {\n      worksheets: this._worksheets.filter(Boolean),\n      definedNames: this._definedNames.model,\n      views: this.views,\n      properties: {},\n      calcProperties: {},\n    };\n\n    return new Promise(resolve => {\n      const xform = new WorkbookXform();\n      xform.prepare(model);\n      zip.append(xform.toXml(model), {name: '/xl/workbook.xml'});\n      resolve();\n    });\n  }\n\n  _finalize() {\n    return new Promise((resolve, reject) => {\n      this.stream.on('error', reject);\n      this.stream.on('finish', () => {\n        resolve(this);\n      });\n      this.zip.on('error', reject);\n\n      this.zip.finalize();\n    });\n  }\n}\n\nasync function parseXMLFile(files, entry) {\n  const xml = (await entry.buffer()).toString();\n  const doc = new DOMParser().parseFromString(xml);\n\n  files[entry.path] = {\n    originalSrc: xml,\n    doc,\n  };\n}\n\nmodule.exports = WorkbookWriter;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,eAAwBA,OAAO,CAAC,gBAAD,CAA/B;AAAA,IAAOC,aAAP,YAAOA,aAAP;;AACA,IAAMC,EAAE,GAAGF,OAAO,CAAC,IAAD,CAAlB;;AACA,gBAAoBA,OAAO,CAAC,QAAD,CAA3B;AAAA,IAAOG,SAAP,aAAOA,SAAP;;AACA,gBAAoBH,OAAO,CAAC,gBAAD,CAA3B;AAAA,IAAOI,SAAP,aAAOA,SAAP;;AACA,IAAMC,QAAQ,GAAGL,OAAO,CAAC,UAAD,CAAxB;;AACA,IAAMM,KAAK,GAAGN,OAAO,CAAC,UAAD,CAArB;;AACA,IAAMO,WAAW,GAAGP,OAAO,CAAC,aAAD,CAA3B;;AACA,IAAMQ,GAAG,GAAGR,OAAO,CAAC,KAAD,CAAnB;;AACA,IAAMS,SAAS,GAAGT,OAAO,CAAC,wBAAD,CAAzB;;AACA,IAAMU,OAAO,GAAGV,OAAO,CAAC,qBAAD,CAAvB;;AACA,IAAMW,WAAW,GAAGX,OAAO,CAAC,qCAAD,CAA3B;;AACA,IAAMY,aAAa,GAAGZ,OAAO,CAAC,4BAAD,CAA7B;;AACA,IAAMa,YAAY,GAAGb,OAAO,CAAC,yBAAD,CAA5B;;AAEA,IAAMc,SAAS,GAAGd,OAAO,CAAC,kCAAD,CAAzB;;AACA,IAAMe,kBAAkB,GAAGf,OAAO,CAAC,2CAAD,CAAlC;;AACA,IAAMgB,iBAAiB,GAAGhB,OAAO,CAAC,2CAAD,CAAjC;;AACA,IAAMiB,QAAQ,GAAGjB,OAAO,CAAC,iCAAD,CAAxB;;AACA,IAAMkB,aAAa,GAAGlB,OAAO,CAAC,sCAAD,CAA7B;;AACA,IAAMmB,kBAAkB,GAAGnB,OAAO,CAAC,+CAAD,CAAlC;;AAEA,IAAMoB,eAAe,GAAGpB,OAAO,CAAC,oBAAD,CAA/B;;AAEA,IAAMqB,SAAS,GAAGrB,OAAO,CAAC,0BAAD,CAAzB;;IAEMsB,c;EACJ,wBAAYC,OAAZ,EAAqB;IAAA;;IACnBA,OAAO,GAAGA,OAAO,IAAI,EAArB;IAEA,KAAKC,OAAL,GAAeD,OAAO,CAACC,OAAR,IAAmB,IAAIC,IAAJ,EAAlC;IACA,KAAKC,QAAL,GAAgBH,OAAO,CAACG,QAAR,IAAoB,KAAKF,OAAzC;IACA,KAAKG,OAAL,GAAeJ,OAAO,CAACI,OAAR,IAAmB,SAAlC;IACA,KAAKC,cAAL,GAAsBL,OAAO,CAACK,cAAR,IAA0B,SAAhD;IACA,KAAKC,WAAL,GAAmBN,OAAO,CAACM,WAA3B,CAPmB,CASnB;;IACA,KAAKC,gBAAL,GAAwBP,OAAO,CAACO,gBAAR,IAA4B,KAApD;IACA,KAAKC,aAAL,GAAqB,IAAInB,aAAJ,EAArB,CAXmB,CAanB;;IACA,IAAIW,OAAO,CAACS,QAAZ,EAAsB;MACpB,KAAKC,MAAL,GAAc,IAAItB,WAAJ,CAAgB,IAAhB,CAAd;IACD,CAFD,MAEO;MACL,KAAKsB,MAAL,GAAcV,OAAO,CAACW,SAAR,GAAoB,IAAIvB,WAAJ,CAAgB,IAAhB,CAApB,GAA4C,IAAIA,WAAW,CAACwB,IAAhB,CAAqB,IAArB,CAA1D;IACD,CAlBkB,CAoBnB;;;IACA,KAAKC,aAAL,GAAqB,IAAIvB,YAAJ,EAArB;IAEA,KAAKwB,WAAL,GAAmB,EAAnB;IAEA,KAAKC,cAAL,GAAsB,IAAIC,GAAJ,EAAtB;IAEA,KAAKC,gBAAL,GAAwB,IAAID,GAAJ,EAAxB;IAEA,KAAKE,KAAL,GAAa,EAAb;IAEA,KAAKC,UAAL,GAAkBnB,OAAO,CAACoB,GAA1B;IAEA,KAAKC,KAAL,GAAa,EAAb;IACA,KAAKC,WAAL,GAAmB,EAAnB;;IAEA,IAAItB,OAAO,CAACS,QAAZ,EAAsB;MACpB,KAAKc,WAAL,GAAmBvB,OAAO,CAACS,QAA3B;MACA,KAAKe,cAAL,GAAsB,EAAtB;MACA,KAAKC,YAAL,GAAoB,EAApB;MACA,KAAKC,WAAL,GAAmB3C,KAAK,CAAC4C,KAAN,EAAnB;IACD;;IAED,KAAKP,GAAL,GAAWtC,QAAQ,CAAC,KAAD,EAAQ,KAAKqC,UAAb,CAAnB;;IACA,IAAInB,OAAO,CAAC4B,MAAZ,EAAoB;MAClB,KAAKA,MAAL,GAAc5B,OAAO,CAAC4B,MAAtB;IACD,CAFD,MAEO,IAAI5B,OAAO,CAAC6B,QAAZ,EAAsB;MAC3B,KAAKD,MAAL,GAAcjD,EAAE,CAACmD,iBAAH,CAAqB9B,OAAO,CAAC6B,QAA7B,CAAd;IACD,CAFM,MAEA;MACL,KAAKD,MAAL,GAAc,IAAI1C,SAAJ,EAAd;IACD;;IACD,KAAKkC,GAAL,CAASW,IAAT,CAAc,KAAKH,MAAnB;;IAEA,IAAI5B,OAAO,CAACS,QAAZ,EAAsB;MACpB,KAAKuB,OAAL,GAAe,IAAIC,OAAJ,CAAY,UAACC,OAAD;QAAA,OAAaA,OAAO,EAApB;MAAA,CAAZ,CAAf;IACD,CAFD,MAEO;MACL;MACA,KAAKF,OAAL,GAAeC,OAAO,CAACE,GAAR,CAAY,CAAC,KAAKC,SAAL,EAAD,EAAmB,KAAKC,aAAL,EAAnB,CAAZ,CAAf;IACD;EACF;;;;SAED,eAAmB;MACjB,OAAO,KAAKxB,aAAZ;IACD;;;WAED,6BAAoByB,IAApB,EAA0B;MACxB,IAAIC,EAAJ;;MAEA,IAAI,KAAKd,YAAT,EAAuB;QACrB,IAAMe,iBAAiB,GAAG,KAAKf,YAAL,CAAkBgB,MAAlB,CAAyBC,IAAzB,CAA8B,UAACC,CAAD;UAAA,OAAOA,CAAC,CAACL,IAAF,KAAWA,IAAlB;QAAA,CAA9B,CAA1B;;QAEA,IAAIE,iBAAJ,EAAuB;UACrBD,EAAE,GAAGC,iBAAiB,CAACI,WAAvB;QACD,CAFD,MAEO;UACLL,EAAE,GAAG,KAAKM,MAAV;QACD;MACF,CARD,MAQO;QACLN,EAAE,GAAG,KAAKM,MAAV;MACD;;MAED,OAAON,EAAP;IACD;;;WAED,qBAAYO,IAAZ,EAAkBC,OAAlB,EAA2B;MACzB,IAAMnB,MAAM,GAAG,IAAI1C,SAAJ,CAAc;QAAC8D,OAAO,EAAE,KAAV;QAAiBC,KAAK,EAAE;MAAxB,CAAd,CAAf;MACA,IAAMC,WAAW,GAAGH,OAAO,IAAI,IAA/B;;MAEA,IAAIG,WAAW,IAAI,KAAKnC,cAAL,CAAoBoC,GAApB,CAAwBJ,OAAxB,CAAnB,EAAqD;QACnD,IAAMK,YAAY,GAAG,KAAKrC,cAAL,CAAoBsC,GAApB,CAAwBN,OAAxB,CAArB;;QACAK,YAAY,CAACE,YAAb,GAA4BR,IAA5B;QAEA,IAAMS,cAAc,GAAG5E,EAAE,CAACmD,iBAAH,CAAqBsB,YAAY,CAACI,OAAlC,CAAvB;QAEAJ,YAAY,CAACK,YAAb,GAA4B,IAAIxB,OAAJ,CAAY,UAACC,OAAD,EAAUwB,MAAV,EAAqB;UAC3DH,cAAc,CAACI,EAAf,CAAkB,OAAlB,EAA2BD,MAA3B;UACAH,cAAc,CAACI,EAAf,CAAkB,QAAlB,EAA4BzB,OAA5B;QACD,CAH2B,CAA5B;QAKAN,MAAM,CAACG,IAAP,CAAYwB,cAAZ;MACD,CAZD,MAYO;QACL,KAAKnC,GAAL,CAASwC,MAAT,CAAgBhC,MAAhB,EAAwB;UAACU,IAAI,EAAEQ;QAAP,CAAxB;MACD;;MAEDlB,MAAM,CAAC+B,EAAP,CAAU,QAAV,EAAoB,YAAM;QACxB/B,MAAM,CAACiC,IAAP,CAAY,QAAZ;MACD,CAFD;MAGA,OAAOjC,MAAP;IACD;;;WAED,6BAAoB;MAClB,IAAMkC,eAAe,GAAG,SAAlBA,eAAkB,CAASC,SAAT,EAAoB;QAC1C,IAAI,CAACA,SAAS,CAACC,SAAf,EAA0B;UACxB,OAAO,IAAI/B,OAAJ,CAAY,UAAAC,OAAO,EAAI;YAC5B6B,SAAS,CAACnC,MAAV,CAAiB+B,EAAjB,CAAoB,QAApB,EAA8B,YAAM;cAClCzB,OAAO;YACR,CAFD;YAGA6B,SAAS,CAACE,MAAV;UACD,CALM,CAAP;QAMD;;QACD,OAAOhC,OAAO,CAACC,OAAR,EAAP;MACD,CAVD,CADkB,CAYlB;;;MACA,IAAMgC,QAAQ,GAAG,KAAKpD,WAAL,CAAiBqD,GAAjB,CAAqBL,eAArB,CAAjB;;MACA,IAAII,QAAQ,CAACE,MAAb,EAAqB;QACnB,OAAOnC,OAAO,CAACE,GAAR,CAAY+B,QAAZ,CAAP;MACD;;MACD,OAAOjC,OAAO,CAACC,OAAR,EAAP;IACD;;;;0FAED;QAAA;;QAAA;QAAA;UAAA;YAAA;cAAA;gBACQmC,cADR,GACyBrF,WAAW,CAACsF,gBAAZ,CAA6B,KAAK/C,WAAlC,CADzB;gBAEQgD,KAFR,GAEgB,EAFhB;gBAGQC,iBAHR,GAG4B,EAH5B;gBAIQC,iBAJR,GAI4B,EAJ5B;gBAAA;gBAAA,OAMQ,IAAIxC,OAAJ,CAAY,UAACC,OAAD,EAAUwB,MAAV,EAAqB;kBACrC,KAAI,CAAChC,WAAL,CAAiBiC,EAAjB,CAAoB,OAApB,EAA6B,UAACe,KAAD,EAAW;oBACtC,QAAQA,KAAK,CAAC5B,IAAd;sBACE,KAAK,qBAAL;sBACA,KAAK,eAAL;sBACA,KAAK,iBAAL;sBACA,KAAK,4BAAL;sBACA,KAAK,kBAAL;wBACE0B,iBAAiB,CAACG,IAAlB,CAAuBC,YAAY,CAACL,KAAD,EAAQG,KAAR,CAAnC;wBACA;;sBACF;wBACE,IAAIA,KAAK,CAAC5B,IAAN,CAAW+B,KAAX,CAAiB,gCAAjB,CAAJ,EAAwD;0BACtDL,iBAAiB,CAACG,IAAlB,CAAuB,IAAI1C,OAAJ,CAAY,UAAC6C,QAAD,EAAWC,OAAX,EAAuB;4BACxD;4BACA9F,GAAG,CAAC+F,IAAJ,CAAS,UAACC,GAAD,EAAMC,WAAN,EAAsB;8BAC7B,IAAID,GAAJ,EAAS;gCAAE,OAAOvB,MAAM,CAACuB,GAAD,CAAb;8BAAqB;;8BAEhC,IAAME,UAAU,GAAGxG,EAAE,CAACmD,iBAAH,CAAqBoD,WAArB,CAAnB;8BAEAT,iBAAiB,CAACE,IAAlB,CAAuB;gCACrBS,GAAG,EAAEV,KAAK,CAAC5B,IADU;gCAErBA,IAAI,EAAEoC;8BAFe,CAAvB;8BAKAR,KAAK,CAACf,EAAN,CAAS,OAAT,EAAkBoB,OAAlB;8BACAI,UAAU,CAACxB,EAAX,CAAc,OAAd,EAAuBoB,OAAvB;8BACAI,UAAU,CAACxB,EAAX,CAAc,QAAd,EAAwBmB,QAAxB;8BAEAJ,KAAK,CAAC3C,IAAN,CAAWoD,UAAX;4BACD,CAfD;0BAgBD,CAlBsB,CAAvB;wBAmBD,CApBD,MAoBO;0BACL,KAAI,CAAC3D,cAAL,CAAoBmD,IAApB,CAAyB,IAAI1C,OAAJ,CAAY,UAAA6C,QAAQ,EAAI;4BAC/C,KAAI,CAAC1D,GAAL,CAASwC,MAAT,CAAgBc,KAAhB,EAAuB;8BAACpC,IAAI,EAAEoC,KAAK,CAAC5B;4BAAb,CAAvB;;4BACAgC,QAAQ;0BACT,CAHwB,CAAzB;wBAID;;wBACD;oBAnCJ;kBAqCD,CAtCD;;kBAwCA,KAAI,CAACpD,WAAL,CAAiBiC,EAAjB,CAAoB,OAApB,EAA6B,YAAM;oBACjCzB,OAAO;kBACR,CAFD;;kBAIA,KAAI,CAACR,WAAL,CAAiBiC,EAAjB,CAAoB,OAApB,EAA6BD,MAA7B;;kBAEAW,cAAc,CAACtC,IAAf,CAAoB,KAAI,CAACL,WAAzB;gBACD,CAhDK,CANR;;cAAA;gBAAA;gBAAA,OAwDQO,OAAO,CAACE,GAAR,CAAYqC,iBAAZ,CAxDR;;cAAA;gBA0DE,KAAK/C,YAAL,CAAkB4D,cAAlB,GAAmCd,KAAnC;gBAEMe,WA5DR,GA4DsB,KAAK7D,YAAL,CAAkB4D,cAAlB,CAAiC,iBAAjC,EAAoDE,GA5D1E;gBA6DQC,OA7DR,GA6DkB,KAAK/D,YAAL,CAAkB4D,cAAlB,CAAiC,4BAAjC,EAA+DE,GA7DjF;gBAkEQ9C,MAlER,GAkEiBgD,KAAK,CAACC,IAAN,CAAWJ,WAAW,CAACK,oBAAZ,CAAiC,OAAjC,CAAX,EAAsDxB,GAAtD,CAA0D,UAACyB,SAAD,EAAe;kBACtF,IAAM7C,OAAO,GAAG8C,QAAQ,CAACD,SAAS,CAACE,YAAV,CAAuB,SAAvB,CAAD,EAAoC,EAApC,CAAxB;kBACA,IAAMC,GAAG,GAAGH,SAAS,CAACE,YAAV,CAAuB,MAAvB,CAAZ;kBACA,IAAME,WAAW,GAAGP,KAAK,CAACC,IAAN,CAAWF,OAAO,CAACG,oBAAR,CAA6B,cAA7B,CAAX,EAAyDjD,IAAzD,CAA8D,UAACuD,KAAD;oBAAA,OAAWA,KAAK,CAACH,YAAN,CAAmB,IAAnB,MAA6BC,GAAxC;kBAAA,CAA9D,CAApB;kBACA,IAAMG,SAAS,GAAGF,WAAW,CAACF,YAAZ,CAAyB,QAAzB,CAAlB;kBACA,IAAMlD,WAAW,GAAGiD,QAAQ,CAACK,SAAS,CAACrB,KAAV,CAAgB,8BAAhB,EAAgD,CAAhD,CAAD,EAAqD,EAArD,CAA5B;kBACA,IAAMsB,cAAc,GAAG1B,iBAAiB,CAAC/B,IAAlB,CAAuB,UAAC0D,CAAD;oBAAA,OAAOA,CAAC,CAAChB,GAAF,kCAAgCxC,WAAhC,SAAP;kBAAA,CAAvB,CAAvB;;kBAEA,IAAIyD,WAAW,IAAI,IAAf,IAAuBA,WAAW,GAAGtD,OAAzC,EAAkD;oBAChDsD,WAAW,GAAGtD,OAAd;kBACD;;kBAED,IAAIuD,eAAe,IAAI,IAAnB,IAA2BA,eAAe,GAAG1D,WAAjD,EAA8D;oBAC5D0D,eAAe,GAAG1D,WAAlB;kBACD;;kBAED,OAAO;oBACLL,EAAE,EAAEQ,OADC;oBAELT,IAAI,EAAEsD,SAAS,CAACE,YAAV,CAAuB,MAAvB,CAFD;oBAGLC,GAAG,EAAHA,GAHK;oBAILG,SAAS,EAATA,SAJK;oBAKLtD,WAAW,EAAXA,WALK;oBAML2D,YAAY,EAAE;sBACZzD,IAAI,EAAEqD,cAAc,CAACrD;oBADT;kBANT,CAAP;gBAUD,CA1Bc,CAlEjB,EA8FE;;gBA9FF;gBAAA,OA+FQ,KAAKpC,MAAL,CAAY8F,WAAZ,CACJxH,WAAW,CAACsF,gBAAZ,CAA6B,KAAK7C,YAAL,CAAkB4D,cAAlB,CAAiC,eAAjC,EAAkDoB,WAA/E,CADI,CA/FR;;cAAA;gBAmGQC,kBAnGR,GAmG6BjB,KAAK,CAACC,IAAN,CACzBF,OAAO,CAACG,oBAAR,CAA6B,cAA7B,CADyB,EAEzBgB,MAFyB,CAElB,UAACC,GAAD,EAAMC,OAAN,EAAkB;kBACzB,IAAMd,GAAG,GAAGc,OAAO,CAACf,YAAR,CAAqB,IAArB,CAAZ;kBACA,IAAMgB,SAAS,GAAGjB,QAAQ,CAACE,GAAG,CAAClB,KAAJ,CAAU,UAAV,EAAsB,CAAtB,CAAD,EAA2B,EAA3B,CAA1B;;kBAEA,IAAIiC,SAAS,GAAGF,GAAhB,EAAqB;oBACnB,OAAOE,SAAP;kBACD;;kBAED,OAAOF,GAAP;gBACD,CAX0B,EAWxB,CAXwB,CAnG7B;gBAgHE,KAAKnF,YAAL,CAAkBgB,MAAlB,GAA2BA,MAA3B;gBACA,KAAKhB,YAAL,CAAkB4E,WAAlB,GAAgCA,WAAhC;gBACA,KAAK5E,YAAL,CAAkB6E,eAAlB,GAAoCA,eAApC;gBACA,KAAK7E,YAAL,CAAkBiF,kBAAlB,GAAuCA,kBAAvC;;cAnHF;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,C;;;;;;;;;;;4EAsHA;QAAA;;QAAA;;QAAA;UAAA;YAAA;cAAA;gBAAA;gBAAA,OAEQ,KAAK1E,OAFb;;cAAA;gBAAA,KAIM,KAAKR,cAJX;kBAAA;kBAAA;gBAAA;;gBAAA;gBAAA,OAKUS,OAAO,CAACE,GAAR,CAAY,KAAKX,cAAjB,CALV;;cAAA;gBAAA;gBAAA,OAQQ,KAAKuF,QAAL,EARR;;cAAA;gBAUQC,aAVR,GAUwB,EAVxB;gBAWQC,sBAXR,GAWiC,IAAIjG,GAAJ,EAXjC;;gBAaE,KAAKF,WAAL,CAAiBoG,OAAjB,CAAyB,UAACd,CAAD,EAAO;kBAC9B,IAAIA,CAAC,IAAI,IAAT,EAAe;oBACb;kBACD,CAH6B,CAK9B;;;kBACA,IAAIX,KAAK,CAAC0B,OAAN,CAAcf,CAAC,CAACgB,QAAhB,CAAJ,EAA+B;oBAC7B;oBACAH,sBAAsB,CAACI,GAAvB,CAA2BjB,CAAC,CAAC7D,EAA7B,EAAiC6D,CAAC,CAACgB,QAAF,CAAWjD,GAAX,CAAe,UAACmD,CAAD,EAAO;sBACrD,OAAO;wBACL;wBACAC,MAAM,EAAED,CAAC,CAACE,OAFL;wBAGLC,KAAK,EAAEH,CAAC,CAACG;sBAHJ,CAAP;oBAKD,CANgC,CAAjC;kBAOD;;kBAEDT,aAAa,CAACrC,IAAd,CAAmByB,CAAnB;gBACD,CAlBD;;gBAoBIsB,kBAjCN,GAiC2B,EAjC3B;;gBAmCE,IAAI,KAAKjG,YAAT,EAAuB;kBACrB,KAAKA,YAAL,CAAkBgB,MAAlB,CAAyByE,OAAzB,CAAiC,UAACS,KAAD,EAAW;oBAC1C,IAAMC,sBAAsB,GAAGZ,aAAa,CAACa,SAAd,CAAwB,UAACzB,CAAD;sBAAA,OAAOA,CAAC,CAAC9D,IAAF,KAAWqF,KAAK,CAACrF,IAAxB;oBAAA,CAAxB,CAA/B;;oBAEA,IAAIsF,sBAAsB,KAAK,CAAC,CAAhC,EAAmC;sBACjCD,KAAK,CAACG,QAAN,GAAiB,IAAjB,CADiC,CAEjC;;sBACAH,KAAK,CAACI,SAAN,GAAkBf,aAAa,CAACY,sBAAD,CAAb,CAAsCI,UAAxD;sBACAhB,aAAa,CAACiB,MAAd,CAAqBL,sBAArB,EAA6C,CAA7C;sBACA;oBACD;;oBAED,MAAI,CAACxG,GAAL,CAASwC,MAAT,CAAgBjF,EAAE,CAAC2F,gBAAH,CAAoBqD,KAAK,CAACpB,YAAN,CAAmBzD,IAAvC,CAAhB,EAA8D;sBAC5DR,IAAI,+BAAwBqF,KAAK,CAAC/E,WAA9B;oBADwD,CAA9D;kBAGD,CAdD;kBAgBA8E,kBAAkB,GAAG,KAAKjG,YAAL,CAAkBgB,MAAlB,CAAyByF,MAAzB,CAAgC,UAAAvF,CAAC;oBAAA,OAAIA,CAAC,CAACmF,QAAF,KAAe,IAAnB;kBAAA,CAAjC,CAArB;gBACD;;gBArDH;gBAAA,OAuDQ,KAAKK,iBAAL,EAvDR;;cAAA;gBAAA,KAyDM,KAAK1G,YAzDX;kBAAA;kBAAA;gBAAA;;gBAAA;kBA2DS;kBAAA,IAAO2G,QAAP;kBAAA;kBAAA,IAAuBC,OAAvB,uBAAkB9C,GAAlB;kBAAA,IAAgCkB,WAAhC,uBAAgCA,WAAhC;;kBACH,IAAI6B,OAAO,GAAG7B,WAAd;;kBAEA,IAAI2B,QAAQ,KAAK,qBAAb,IAAsCpB,aAAa,CAAC5C,MAAd,GAAuB,CAAjE,EAAoE;oBAClE,IAAMmE,YAAY,GAAG9C,KAAK,CAACC,IAAN,CACnB2C,OAAO,CAAC1C,oBAAR,CAA6B,UAA7B,CADmB,EAEnBjD,IAFmB,CAEd,UAAC8F,IAAD,EAAU;sBACf,OAAOA,IAAI,CAAC1C,YAAL,CAAkB,UAAlB,oCAAyD,MAAI,CAACrE,YAAL,CAAkB6E,eAA3E,SAAP;oBACD,CAJoB,CAArB,CADkE,CAOlE;;oBAPkE,2CAQvCU,aARuC;oBAAA;;oBAAA;sBAQlE,oDAA0C;wBAAA,IAA/ByB,YAA+B;wBACxC,IAAMC,eAAe,GAAGH,YAAY,CAACI,SAAb,EAAxB;wBACAD,eAAe,CAACE,YAAhB,CAA6B,UAA7B,gCAAgEH,YAAY,CAAClG,EAA7E;wBACAgG,YAAY,CAACM,UAAb,CAAwBC,YAAxB,CAAqCJ,eAArC,EAAsDH,YAAY,CAACQ,WAAnE;sBACD;oBAZiE;sBAAA;oBAAA;sBAAA;oBAAA;;oBAclET,OAAO,GAAGD,OAAO,CAACW,QAAR,EAAV;kBACD,CAfD,MAeO,IAAIZ,QAAQ,KAAK,eAAjB,EAAkC;oBACvCE,OAAO,GAAG,MAAI,CAAC5H,MAAL,CAAYuI,GAAtB;kBACD,CAFM,MAEA,IAAIb,QAAQ,KAAK,iBAAb,IAAkCpB,aAAa,CAAC5C,MAAd,GAAuB,CAA7D,EAAgE;oBACrE,IAAM8E,UAAU,GAAGb,OAAO,CAAC1C,oBAAR,CAA6B,QAA7B,EAAuC,CAAvC,CAAnB;;oBAEA,KAAK,IAAIwD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGnC,aAAa,CAAC5C,MAAlC,EAA0C+E,CAAC,EAA3C,EAA+C;sBAC7C,IAAMV,aAAY,GAAGzB,aAAa,CAACmC,CAAD,CAAlC;sBACA,IAAMC,YAAY,GAAGf,OAAO,CAACgB,aAAR,CAAsB,OAAtB,CAArB;sBACAD,YAAY,CAACR,YAAb,CAA0B,MAA1B,EAAkCH,aAAY,CAACnG,IAA/C;sBACA8G,YAAY,CAACR,YAAb,CAA0B,SAA1B,EAAqC,MAAI,CAACnH,YAAL,CAAkB4E,WAAlB,GAAgC8C,CAAhC,GAAoC,CAAzE;sBACAC,YAAY,CAACR,YAAb,CAA0B,MAA1B,eAAwC,MAAI,CAACnH,YAAL,CAAkBiF,kBAAlB,GAAuCyC,CAAvC,GAA2C,CAAnF;sBACAD,UAAU,CAACI,WAAX,CAAuBF,YAAvB;oBACD;;oBAEDd,OAAO,GAAGD,OAAO,CAACW,QAAR,EAAV;kBACD,CAbM,MAaA,IAAIZ,QAAQ,KAAK,4BAAb,IAA6CpB,aAAa,CAAC5C,MAAd,GAAuB,CAAxE,EAA2E;oBAChF,IAAMmF,iBAAiB,GAAGlB,OAAO,CAAC1C,oBAAR,CAA6B,eAA7B,EAA8C,CAA9C,CAA1B;;oBAEA,KAAK,IAAIwD,GAAC,GAAG,CAAb,EAAgBA,GAAC,GAAGnC,aAAa,CAAC5C,MAAlC,EAA0C+E,GAAC,EAA3C,EAA+C;sBAC7C,IAAMV,cAAY,GAAGzB,aAAa,CAACmC,GAAD,CAAlC;sBACA,IAAMK,UAAU,GAAGnB,OAAO,CAACgB,aAAR,CAAsB,cAAtB,CAAnB;sBACAG,UAAU,CAACZ,YAAX,CAAwB,IAAxB,eAAoC,MAAI,CAACnH,YAAL,CAAkBiF,kBAAlB,GAAuCyC,GAAvC,GAA2C,CAA/E;sBACAK,UAAU,CAACZ,YAAX,CAAwB,MAAxB,EAAgC,+EAAhC;sBACAY,UAAU,CAACZ,YAAX,CAAwB,QAAxB,4BAAqDH,cAAY,CAAClG,EAAlE;sBACAgH,iBAAiB,CAACD,WAAlB,CAA8BE,UAA9B;oBACD;;oBAEDlB,OAAO,GAAGD,OAAO,CAACW,QAAR,EAAV;kBACD,CAbM,MAaA,IAAIZ,QAAQ,KAAK,kBAAb,IAAmCV,kBAAkB,CAACtD,MAAnB,GAA4B,CAAnE,EAAsE;oBAC3E,IAAMqF,aAAa,GAAGpB,OAAO,CAAC1C,oBAAR,CAA6B,WAA7B,EAA0C,CAA1C,CAAtB;oBACA,IAAM+D,YAAY,GAAGjE,KAAK,CAACC,IAAN,CAAW2C,OAAO,CAAC1C,oBAAR,CAA6B,GAA7B,CAAX,CAArB;oBAEA,IAAMgE,iBAAiB,GAAG,EAA1B;oBAEAD,YAAY,CAACxC,OAAb,CAAqB,UAAC0C,WAAD,EAAiB;sBACpC,IAAMC,cAAc,GAAGhE,QAAQ,CAAC+D,WAAW,CAAC9D,YAAZ,CAAyB,GAAzB,CAAD,EAAgC,EAAhC,CAA/B;sBACA,IAAMgE,OAAO,GAAGF,WAAW,CAAC9D,YAAZ,CAAyB,GAAzB,CAAhB;sBACA,IAAMiE,sBAAsB,GAAGrC,kBAAkB,CAAChF,IAAnB,CAAwB,UAAA0D,CAAC;wBAAA,OAAIA,CAAC,CAAC7D,EAAF,KAASsH,cAAb;sBAAA,CAAzB,CAA/B;;sBAEA,IAAI,CAACE,sBAAL,EAA6B;wBAC3B;sBACD;;sBAED,IAAI,CAACA,sBAAsB,CAAChC,SAAvB,CAAiC+B,OAAjC,CAAL,EAAgD;wBAC9CF,WAAW,CAACf,UAAZ,CAAuBmB,WAAvB,CAAmCJ,WAAnC;sBACD,CAFD,MAEO;wBACLD,iBAAiB,CAACE,cAAD,CAAjB,GAAoCF,iBAAiB,CAACE,cAAD,CAAjB,IAAqC,EAAzE;wBACAF,iBAAiB,CAACE,cAAD,CAAjB,CAAkCC,OAAlC,IAA6C,IAA7C;sBACD;oBACF,CAfD;oBAiBApC,kBAAkB,CAACR,OAAnB,CAA2B,UAAC+C,iBAAD,EAAuB;sBAChD,IAAMC,oBAAoB,GAAGP,iBAAiB,CAACM,iBAAiB,CAAC1H,EAAnB,CAAjB,IAA2C,EAAxE,CADgD,CAGhD;;sBACA,qCAA4B4H,MAAM,CAACC,OAAP,CAAeH,iBAAiB,CAAClC,SAAjC,CAA5B,wCAAyE;wBAApE;wBAAA,IAAOsC,WAAP;;wBACH,IAAI,CAACH,oBAAoB,CAACG,WAAD,CAAzB,EAAwC;0BACtC,IAAMC,UAAU,GAAGjC,OAAO,CAACgB,aAAR,CAAsB,GAAtB,CAAnB;0BACAiB,UAAU,CAAC1B,YAAX,CAAwB,GAAxB,EAA6ByB,WAA7B;0BACAC,UAAU,CAAC1B,YAAX,CAAwB,GAAxB,EAA6BqB,iBAAiB,CAAC1H,EAA/C;0BACAkH,aAAa,CAACH,WAAd,CAA0BgB,UAA1B;wBACD;sBACF;oBACF,CAZD;oBAcAhC,OAAO,GAAGD,OAAO,CAACW,QAAR,EAAV;kBACD;;kBAED,MAAI,CAAC5H,GAAL,CAASwC,MAAT,CAAgB0E,OAAhB,EAAyB;oBACvBhG,IAAI,EAAE8F;kBADiB,CAAzB;gBAjJN;;gBA0DI;gBACA,+BAAsD+B,MAAM,CAACC,OAAP,CAAe,KAAK3I,YAAL,CAAkB4D,cAAjC,CAAtD,qCAAwG;kBAAA;gBAyFvG;;gBApJL;gBAAA;;cAAA;gBAAA;gBAAA,OAsJUpD,OAAO,CAACE,GAAR,CAAY,CAChB,KAAKoI,eAAL,EADgB,EAEhB,KAAKC,MAAL,EAFgB,EAGhB,KAAKC,OAAL,EAHgB,EAIhB,KAAKC,gBAAL,EAJgB,EAKhB,KAAKC,SAAL,EALgB,EAMhB,KAAKC,eAAL,EANgB,CAAZ,CAtJV;;cAAA;gBAAA;gBAAA,OA+JU,KAAKC,WAAL,EA/JV;;cAAA;gBAkKQC,4BAlKR,GAkKuC,EAlKvC;;gBAoKE,KAAK/J,cAAL,CAAoBmG,OAApB,CAA4B,UAAC6D,KAAD,EAAW;kBACrCD,4BAA4B,CAACnG,IAA7B,CAAkCoG,KAAK,CAACtH,YAAxC;gBACD,CAFD;;gBApKF;gBAAA,OAwKQxB,OAAO,CAACE,GAAR,CAAY2I,4BAAZ,CAxKR;;cAAA;gBA0KQE,gBA1KR,GA0K2B,EA1K3B,EA4KE;;gBA5KF,wCA6KwC,KAAKjK,cAAL,CAAoBqJ,OAApB,EA7KxC;;gBAAA;kBA6KE,uDAAqE;oBAAA,gDAAzDrH,OAAyD,oBAAhDK,YAAgD;oBACnE4H,gBAAgB,CAACrG,IAAjB,CAAsB;sBACpB5B,OAAO,EAAPA,OADoB;sBAEpBK,YAAY,EAAZA;oBAFoB,CAAtB;kBAID,CAlLH,CAoLE;;gBApLF;kBAAA;gBAAA;kBAAA;gBAAA;;gBAAA;kBAAA;kBAAA;oBAAA;sBAAA;wBAAA;0BAqLagD,CArLb;0BAsLWrD,OAtLX,GAsLoCqD,CAtLpC,CAsLWrD,OAtLX,EAsLoBK,YAtLpB,GAsLoCgD,CAtLpC,CAsLoBhD,YAtLpB,EAwLI;;0BAxLJ;0BAAA,OAyLU,IAAInB,OAAJ,CAAY,UAACC,OAAD,EAAUwB,MAAV,EAAqB;4BACrC,IAAMuH,eAAe,GAAGtM,EAAE,CAAC2F,gBAAH,CAAoBlB,YAAY,CAACI,OAAjC,CAAxB;4BACA,IAAM0H,OAAO,GAAG,IAAIxM,aAAJ,CAAkB,MAAlB,CAAhB;4BACA,IAAIyM,gBAAgB,GAAG,KAAvB;4BAEA,IAAMC,UAAU,GAAG,IAAIxM,SAAJ,CAAc;8BAC/ByM,SAAS,EAAE,mBAACC,KAAD,EAAQC,GAAR,EAAaC,EAAb,EAAoB;gCAC7B,IAAMC,QAAQ,GAAGP,OAAO,CAACQ,KAAR,CAAcJ,KAAd,CAAjB;;gCAEA,IAAI,CAACH,gBAAD,IAAqBM,QAAQ,CAACE,QAAT,CAAkB,cAAlB,CAAzB,EAA4D;kCAC1DR,gBAAgB,GAAG,IAAnB;kCACA,IAAIS,OAAO,GAAG,MAAI,CAAC9K,WAAL,CAAiBiC,OAAjB,EAA0B8I,UAAxC;kCAEAD,OAAO,GAAGA,OAAO,CAACE,KAAR,CAAc,SAAS1H,MAAvB,EAA+B0H,KAA/B,CAAqC,CAArC,EAAwC,UAAU1H,MAAV,GAAmB,CAAC,CAA5D,CAAV;kCAEAoH,EAAE,CAAC,IAAD,EAAOC,QAAQ,CAACM,OAAT,CAAiB,cAAjB,EAAiCH,OAAjC,CAAP,CAAF;gCACD,CAPD,MAOO;kCACLJ,EAAE,CAAC,IAAD,EAAOC,QAAP,CAAF;gCACD;8BACF,CAd8B;8BAe/BO,KAAK,EAAE,eAACR,EAAD,EAAQ;gCACb,IAAMS,GAAG,GAAGf,OAAO,CAACgB,GAAR,EAAZ;;gCAEA,IAAID,GAAG,KAAK,EAAZ,EAAgB;kCACdT,EAAE,CAAC,IAAD,EAAOS,GAAP,CAAF;gCACD,CAFD,MAEO;kCACLT,EAAE;gCACH;8BACF;4BAvB8B,CAAd,CAAnB;4BA0BAJ,UAAU,CAACzH,EAAX,CAAc,QAAd,EAAwBzB,OAAxB;4BACA+I,eAAe,CAACtH,EAAhB,CAAmB,OAAnB,EAA4BD,MAA5B;4BACA0H,UAAU,CAACzH,EAAX,CAAc,OAAd,EAAuBD,MAAvB;;4BAEA,MAAI,CAACtC,GAAL,CAASwC,MAAT,CAAgBwH,UAAhB,EAA4B;8BAC1B9I,IAAI,EAAEc,YAAY,CAACE;4BADO,CAA5B;;4BAIA2H,eAAe,CAAClJ,IAAhB,CAAqBqJ,UAArB;0BACD,CAxCK,CAzLV;;wBAAA;wBAAA;0BAAA;sBAAA;oBAAA;kBAAA;gBAAA;gBAAA,6BAqLkBJ,gBArLlB;;cAAA;gBAAA;kBAAA;kBAAA;gBAAA;;gBAAA;;cAAA;gBAAA;gBAAA;gBAAA;;cAAA;gBAAA;gBAAA,OAoOuB,KAAKmB,SAAL,EApOvB;;cAAA;gBAoOQC,MApOR;gBAAA,kCAsOSA,MAtOT;;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,C;;;;;;;;;;SAyOA,eAAa;MACX,IAAI7J,EAAJ,CADW,CAEX;;MACA,IAAI4G,CAAJ;;MAEA,IAAI,KAAK1H,YAAL,IAAqB,KAAKA,YAAL,CAAkB6E,eAAlB,IAAqC,IAA9D,EAAoE;QAClE,IAAM+F,gBAAgB,GAAG,KAAK5K,YAAL,CAAkBgB,MAAlB,CAAyB0B,GAAzB,CAA6B,UAACxB,CAAD;UAAA,OAAOA,CAAC,CAACC,WAAT;QAAA,CAA7B,CAAzB;QAEA,IAAM0J,cAAc,GAAGnC,MAAM,CAACoC,MAAP,CAAc,KAAKzL,WAAnB,EAAgCoH,MAAhC,CAAuC,UAACsE,CAAD,EAAO;UACnE,OAAOH,gBAAgB,CAACV,QAAjB,CAA0Ba,CAAC,CAACjK,EAA5B,MAAoC,KAA3C;QACD,CAFsB,CAAvB;QAIA,OAAO,KAAKd,YAAL,CAAkB6E,eAAlB,GAAoCgG,cAAc,CAAClI,MAAnD,GAA4D,CAAnE;MACD;;MAED,KAAK+E,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,KAAKrI,WAAL,CAAiBsD,MAAjC,EAAyC+E,CAAC,EAA1C,EAA8C;QAC5C,IAAI,CAAC,KAAKrI,WAAL,CAAiBqI,CAAjB,CAAL,EAA0B;UACxB5G,EAAE,GAAG4G,CAAL;UACA;QACD;MACF;;MAED,IAAI5G,EAAE,IAAI,IAAV,EAAgB;QACdA,EAAE,GAAG,KAAKzB,WAAL,CAAiBsD,MAAjB,IAA2B,CAAhC;MACD;;MAED,OAAO7B,EAAP;IACD;;;WAED,kBAASkK,KAAT,EAAgB;MACd,IAAMlK,EAAE,GAAG,KAAKlB,KAAL,CAAW+C,MAAtB;MACA,KAAK/C,KAAL,CAAWsD,IAAX,CAAgBwF,MAAM,CAACuC,MAAP,CAAc,EAAd,EAAkBD,KAAlB,EAAyB;QAACE,IAAI,EAAE;MAAP,CAAzB,CAAhB;MACA,OAAOpK,EAAP;IACD;;;WAED,kBAASA,EAAT,EAAa;MACX,OAAO,KAAKlB,KAAL,CAAWkB,EAAX,CAAP;IACD;;;WAED,sBAAaD,IAAb,EAAmBtC,OAAnB,EAA4B;MAC1B;MACA;MACA;MACAA,OAAO,GAAGA,OAAO,IAAI,EAArB;MACA,IAAMO,gBAAgB,GAAGP,OAAO,CAACO,gBAAR,KAA6BqM,SAA7B,GAAyC5M,OAAO,CAACO,gBAAjD,GAAoE,KAAKA,gBAAlG;;MAEA,IAAIP,OAAO,CAAC6M,QAAZ,EAAsB;QACpB;QACAC,OAAO,CAACC,KAAR,CAAc,8DAAd;QACA/M,OAAO,CAACgN,UAAR,GAAqB7C,MAAM,CAACuC,MAAP,CACnB;UACEG,QAAQ,EAAE7M,OAAO,CAAC6M;QADpB,CADmB,EAInB7M,OAAO,CAACgN,UAJW,CAArB;MAMD;;MAED,IAAIzK,EAAJ;;MAEA,IAAIvC,OAAO,CAACuC,EAAZ,EAAgB;QACd;QACAA,EAAE,GAAGvC,OAAO,CAACuC,EAAb;QACA,OAAOvC,OAAO,CAACuC,EAAf;MACD,CAJD,MAIO;QACLA,EAAE,GAAG,KAAK0K,mBAAL,CAAyB3K,IAAzB,CAAL;MACD;;MAEDA,IAAI,GAAGA,IAAI,mBAAYC,EAAZ,CAAX;MAEA,IAAMwB,SAAS,GAAG,IAAIlE,eAAJ,CAAoB;QACpC0C,EAAE,EAAFA,EADoC;QAEpCD,IAAI,EAAJA,IAFoC;QAGpC4K,QAAQ,EAAE,IAH0B;QAIpC3M,gBAAgB,EAAhBA,gBAJoC;QAKpCyM,UAAU,EAAEhN,OAAO,CAACgN,UALgB;QAMpCG,KAAK,EAAEnN,OAAO,CAACmN,KANqB;QAOpCC,SAAS,EAAEpN,OAAO,CAACoN,SAPiB;QAQpClM,KAAK,EAAElB,OAAO,CAACkB,KARqB;QASpCmM,UAAU,EAAErN,OAAO,CAACqN;MATgB,CAApB,CAAlB;MAYA,KAAKvM,WAAL,CAAiByB,EAAjB,IAAuBwB,SAAvB;MACA,OAAOA,SAAP;IACD;;;;uFAED,kBAAwBzB,IAAxB,EAA8BtC,OAA9B;QAAA;QAAA;UAAA;YAAA;cAAA;gBACQuC,EADR,GACa,KAAK0K,mBAAL,CAAyB3K,IAAzB,CADb;gBAAA;gBAAA,OAGwB,IAAIL,OAAJ,CAAY,UAACC,OAAD,EAAUwB,MAAV,EAAqB;kBACrD;kBACAzE,GAAG,CAAC+F,IAAJ,CAAS,UAACC,GAAD,EAAMC,WAAN,EAAsB;oBAC7B,IAAID,GAAJ,EAAS;sBAAE,OAAOvB,MAAM,CAACuB,GAAD,CAAb;oBAAqB;;oBAChC/C,OAAO,CAACgD,WAAD,CAAP;kBACD,CAHD;gBAID,CANqB,CAHxB;;cAAA;gBAGQ1B,OAHR;;gBAWE,KAAKzC,cAAL,CAAoBsG,GAApB,CAAwB9E,EAAxB,EAA4B;kBAC1BiB,OAAO,EAAPA;gBAD0B,CAA5B;;gBAXF,kCAeS,KAAK8J,YAAL,CAAkBhL,IAAlB,kCACFtC,OADE;kBAELuC,EAAE,EAAFA;gBAFK,GAfT;;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA,C;;;;;;;;;;WAqBA,sBAAaA,EAAb,EAAiB;MACf,IAAIA,EAAE,KAAKqK,SAAX,EAAsB;QACpB,OAAO,KAAK9L,WAAL,CAAiB4B,IAAjB,CAAsB;UAAA,OAAM,IAAN;QAAA,CAAtB,CAAP;MACD;;MACD,IAAI,OAAOH,EAAP,KAAc,QAAlB,EAA4B;QAC1B,OAAO,KAAKzB,WAAL,CAAiByB,EAAjB,CAAP;MACD;;MACD,IAAI,OAAOA,EAAP,KAAc,QAAlB,EAA4B;QAC1B,OAAO,KAAKzB,WAAL,CAAiB4B,IAAjB,CAAsB,UAAAqB,SAAS;UAAA,OAAIA,SAAS,IAAIA,SAAS,CAACzB,IAAV,KAAmBC,EAApC;QAAA,CAA/B,CAAP;MACD;;MACD,OAAOqK,SAAP;IACD;;;WAED,qBAAY;MAAA;;MACV,OAAO,IAAI3K,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,MAAI,CAACd,GAAL,CAASwC,MAAT,CAAgB,MAAI,CAAClD,MAAL,CAAYuI,GAA5B,EAAiC;UAAC3G,IAAI,EAAE;QAAP,CAAjC;;QACAJ,OAAO;MACR,CAHM,CAAP;IAID;;;WAED,qBAAY;MAAA;;MACV,OAAO,IAAID,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,MAAI,CAACd,GAAL,CAASwC,MAAT,CAAgB9D,SAAhB,EAA2B;UAACwC,IAAI,EAAE;QAAP,CAA3B;;QACAJ,OAAO;MACR,CAHM,CAAP;IAID;;;WAED,yBAAgB;MAAA;;MACd,OAAO,IAAID,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,IAAMqL,KAAK,GAAG,IAAI/N,kBAAJ,EAAd;QACA,IAAMyJ,GAAG,GAAGsE,KAAK,CAACC,KAAN,CAAY,CACtB;UAACC,EAAE,EAAE,MAAL;UAAaC,IAAI,EAAEvO,OAAO,CAACwO,cAA3B;UAA2CC,MAAM,EAAE;QAAnD,CADsB,EAEtB;UAACH,EAAE,EAAE,MAAL;UAAaC,IAAI,EAAEvO,OAAO,CAAC0O,cAA3B;UAA2CD,MAAM,EAAE;QAAnD,CAFsB,EAGtB;UAACH,EAAE,EAAE,MAAL;UAAaC,IAAI,EAAEvO,OAAO,CAAC2O,kBAA3B;UAA+CF,MAAM,EAAE;QAAvD,CAHsB,CAAZ,CAAZ;;QAKA,MAAI,CAACxM,GAAL,CAASwC,MAAT,CAAgBqF,GAAhB,EAAqB;UAAC3G,IAAI,EAAE;QAAP,CAArB;;QACAJ,OAAO;MACR,CATM,CAAP;IAUD;;;WAED,2BAAkB;MAAA;;MAChB,OAAO,IAAID,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,IAAM6L,KAAK,GAAG;UACZC,UAAU,EAAE,MAAI,CAAClN,WAAL,CAAiBoH,MAAjB,CAAwB+F,OAAxB,CADA;UAEZzN,aAAa,EAAE,MAAI,CAACA,aAFR;UAGZc,WAAW,EAAE,MAAI,CAACA,WAHN;UAIZD,KAAK,EAAE,MAAI,CAACA;QAJA,CAAd;QAMA,IAAMkM,KAAK,GAAG,IAAI9N,iBAAJ,EAAd;QACA,IAAMwJ,GAAG,GAAGsE,KAAK,CAACC,KAAN,CAAYO,KAAZ,CAAZ;;QACA,MAAI,CAAC3M,GAAL,CAASwC,MAAT,CAAgBqF,GAAhB,EAAqB;UAAC3G,IAAI,EAAE;QAAP,CAArB;;QACAJ,OAAO;MACR,CAXM,CAAP;IAYD;;;WAED,oBAAW;MAAA;;MACT,OAAOD,OAAO,CAACE,GAAR,CACL,KAAKd,KAAL,CAAW8C,GAAX,CAAe,UAAC+J,MAAD,EAASC,GAAT,EAAiB;QAC9BD,MAAM,CAAC5L,IAAP,kBAAsB6L,GAAG,GAAC,CAA1B,cAA+BD,MAAM,CAACE,SAAtC;;QACA,IAAIF,MAAM,CAACvB,IAAP,KAAgB,OAApB,EAA6B;UAC3B,IAAM9K,QAAQ,sBAAeqM,MAAM,CAAC5L,IAAtB,CAAd;;UACA,IAAI4L,MAAM,CAACrM,QAAX,EAAqB;YACnB,OAAO,MAAI,CAACT,GAAL,CAAS4D,IAAT,CAAckJ,MAAM,CAACrM,QAArB,EAA+B;cAACS,IAAI,EAAET;YAAP,CAA/B,CAAP;UACD;;UACD,IAAIqM,MAAM,CAACG,MAAX,EAAmB;YACjB,OAAO,MAAI,CAACjN,GAAL,CAASwC,MAAT,CAAgBsK,MAAM,CAACG,MAAvB,EAA+B;cAAC/L,IAAI,EAAET;YAAP,CAA/B,CAAP;UACD;;UACD,IAAIqM,MAAM,CAACI,MAAX,EAAmB;YACjB,IAAMC,SAAS,GAAGL,MAAM,CAACI,MAAzB;YACA,IAAMhG,OAAO,GAAGiG,SAAS,CAACC,SAAV,CAAoBD,SAAS,CAACE,OAAV,CAAkB,GAAlB,IAAyB,CAA7C,CAAhB;YACA,OAAO,MAAI,CAACrN,GAAL,CAASwC,MAAT,CAAgB0E,OAAhB,EAAyB;cAAChG,IAAI,EAAET,QAAP;cAAiByM,MAAM,EAAE;YAAzB,CAAzB,CAAP;UACD;QACF;;QACD,MAAM,IAAII,KAAJ,CAAU,mBAAV,CAAN;MACD,CAjBD,CADK,CAAP;IAoBD;;;WAED,kBAAS;MAAA;;MACP,OAAO,IAAIzM,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,IAAM6L,KAAK,GAAG;UACZC,UAAU,EAAE,MAAI,CAAClN,WAAL,CAAiBoH,MAAjB,CAAwB+F,OAAxB;QADA,CAAd;QAGA,IAAMV,KAAK,GAAG,IAAI7N,QAAJ,EAAd;QACA,IAAMuJ,GAAG,GAAGsE,KAAK,CAACC,KAAN,CAAYO,KAAZ,CAAZ;;QACA,MAAI,CAAC3M,GAAL,CAASwC,MAAT,CAAgBqF,GAAhB,EAAqB;UAAC3G,IAAI,EAAE;QAAP,CAArB;;QACAJ,OAAO;MACR,CARM,CAAP;IASD;;;WAED,mBAAU;MAAA;;MACR,OAAO,IAAID,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,IAAMyM,SAAS,GAAG,IAAIpP,SAAJ,EAAlB;QACA,IAAM0J,GAAG,GAAG0F,SAAS,CAACnB,KAAV,CAAgB,MAAhB,CAAZ;;QACA,MAAI,CAACpM,GAAL,CAASwC,MAAT,CAAgBqF,GAAhB,EAAqB;UAAC3G,IAAI,EAAE;QAAP,CAArB;;QACAJ,OAAO;MACR,CALM,CAAP;IAMD;;;WAED,4BAAmB;MAAA;;MACjB,IAAI,KAAK1B,aAAL,CAAmBoO,KAAvB,EAA8B;QAC5B,OAAO,IAAI3M,OAAJ,CAAY,UAAAC,OAAO,EAAI;UAC5B,IAAM2M,kBAAkB,GAAG,IAAIjP,kBAAJ,EAA3B;UACA,IAAMqJ,GAAG,GAAG4F,kBAAkB,CAACrB,KAAnB,CAAyB,OAAI,CAAChN,aAA9B,CAAZ;;UACA,OAAI,CAACY,GAAL,CAASwC,MAAT,CAAgBqF,GAAhB,EAAqB;YAAC3G,IAAI,EAAE;UAAP,CAArB;;UACAJ,OAAO;QACR,CALM,CAAP;MAMD;;MACD,OAAOD,OAAO,CAACC,OAAR,EAAP;IACD;;;WAED,2BAAkB;MAAA;;MAChB,IAAI0M,KAAK,GAAG,CAAZ;MACA,IAAME,aAAa,GAAG,CACpB;QAACrB,EAAE,eAAQmB,KAAK,EAAb,CAAH;QAAsBlB,IAAI,EAAEvO,OAAO,CAAC4P,MAApC;QAA4CnB,MAAM,EAAE;MAApD,CADoB,EAEpB;QAACH,EAAE,eAAQmB,KAAK,EAAb,CAAH;QAAsBlB,IAAI,EAAEvO,OAAO,CAAC6P,KAApC;QAA2CpB,MAAM,EAAE;MAAnD,CAFoB,CAAtB;;MAIA,IAAI,KAAKpN,aAAL,CAAmBoO,KAAvB,EAA8B;QAC5BE,aAAa,CAACnK,IAAd,CAAmB;UAAC8I,EAAE,eAAQmB,KAAK,EAAb,CAAH;UAAsBlB,IAAI,EAAEvO,OAAO,CAACE,aAApC;UAAmDuO,MAAM,EAAE;QAA3D,CAAnB;MACD;;MACD,KAAK9M,WAAL,CAAiBoG,OAAjB,CAAyB,UAAAnD,SAAS,EAAI;QACpC,IAAIA,SAAJ,EAAe;UACbA,SAAS,CAACgC,GAAV,gBAAsB6I,KAAK,EAA3B;UACAE,aAAa,CAACnK,IAAd,CAAmB;YAAC8I,EAAE,EAAE1J,SAAS,CAACgC,GAAf;YAAoB2H,IAAI,EAAEvO,OAAO,CAAC8P,SAAlC;YAA6CrB,MAAM,4BAAqB7J,SAAS,CAACxB,EAA/B;UAAnD,CAAnB;QACD;MACF,CALD;;MAMA,OAAO,IAAIN,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,IAAMqL,KAAK,GAAG,IAAI/N,kBAAJ,EAAd;QACA,IAAMyJ,GAAG,GAAGsE,KAAK,CAACC,KAAN,CAAYsB,aAAZ,CAAZ;;QACA,OAAI,CAAC1N,GAAL,CAASwC,MAAT,CAAgBqF,GAAhB,EAAqB;UAAC3G,IAAI,EAAE;QAAP,CAArB;;QACAJ,OAAO;MACR,CALM,CAAP;IAMD;;;WAED,uBAAc;MACZ,IAAOd,GAAP,GAAc,IAAd,CAAOA,GAAP;MACA,IAAM2M,KAAK,GAAG;QACZC,UAAU,EAAE,KAAKlN,WAAL,CAAiBoH,MAAjB,CAAwB+F,OAAxB,CADA;QAEZiB,YAAY,EAAE,KAAKrO,aAAL,CAAmBkN,KAFrB;QAGZ7M,KAAK,EAAE,KAAKA,KAHA;QAIZ8L,UAAU,EAAE,EAJA;QAKZmC,cAAc,EAAE;MALJ,CAAd;MAQA,OAAO,IAAIlN,OAAJ,CAAY,UAAAC,OAAO,EAAI;QAC5B,IAAMqL,KAAK,GAAG,IAAI5N,aAAJ,EAAd;QACA4N,KAAK,CAAC6B,OAAN,CAAcrB,KAAd;QACA3M,GAAG,CAACwC,MAAJ,CAAW2J,KAAK,CAACC,KAAN,CAAYO,KAAZ,CAAX,EAA+B;UAACzL,IAAI,EAAE;QAAP,CAA/B;QACAJ,OAAO;MACR,CALM,CAAP;IAMD;;;WAED,qBAAY;MAAA;;MACV,OAAO,IAAID,OAAJ,CAAY,UAACC,OAAD,EAAUwB,MAAV,EAAqB;QACtC,OAAI,CAAC9B,MAAL,CAAY+B,EAAZ,CAAe,OAAf,EAAwBD,MAAxB;;QACA,OAAI,CAAC9B,MAAL,CAAY+B,EAAZ,CAAe,QAAf,EAAyB,YAAM;UAC7BzB,OAAO,CAAC,OAAD,CAAP;QACD,CAFD;;QAGA,OAAI,CAACd,GAAL,CAASuC,EAAT,CAAY,OAAZ,EAAqBD,MAArB;;QAEA,OAAI,CAACtC,GAAL,CAASiO,QAAT;MACD,CARM,CAAP;IASD;;;;;;SAGYzK,Y;;;;;0EAAf,kBAA4BL,KAA5B,EAAmCG,KAAnC;IAAA;IAAA;MAAA;QAAA;UAAA;YAAA;YAAA,OACqBA,KAAK,CAAC2J,MAAN,EADrB;;UAAA;YACQpF,GADR,kBACqCD,QADrC;YAEQzD,GAFR,GAEc,IAAI1G,SAAJ,GAAgByQ,eAAhB,CAAgCrG,GAAhC,CAFd;YAIE1E,KAAK,CAACG,KAAK,CAAC5B,IAAP,CAAL,GAAoB;cAClB2D,WAAW,EAAEwC,GADK;cAElB1D,GAAG,EAAHA;YAFkB,CAApB;;UAJF;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,C;;;;AAUAgK,MAAM,CAACC,OAAP,GAAiBzP,cAAjB"}