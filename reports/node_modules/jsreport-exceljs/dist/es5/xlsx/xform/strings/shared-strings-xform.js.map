{"version":3,"file":"shared-strings-xform.js","names":["XmlStream","require","BaseXform","SharedStringXform","SharedStringsXform","model","values","count","hash","rich","_sharedStringXform","length","index","value","richText","addRichText","addText","undefined","push","xml","sharedStringXform","toXml","xmlStream","_values","openXml","StdDocAttributes","openNode","xmlns","uniqueCount","sx","forEach","sharedString","render","closeNode","node","parser","parseOpen","name","Error","JSON","stringify","text","parseText","parseClose","module","exports"],"sources":["../../../../../lib/xlsx/xform/strings/shared-strings-xform.js"],"sourcesContent":["const XmlStream = require('../../../utils/xml-stream');\nconst BaseXform = require('../base-xform');\nconst SharedStringXform = require('./shared-string-xform');\n\nclass SharedStringsXform extends BaseXform {\n  constructor(model) {\n    super();\n\n    this.model = model || {\n      values: [],\n      count: 0,\n    };\n    this.hash = {};\n    this.rich = {};\n  }\n\n  get sharedStringXform() {\n    return this._sharedStringXform || (this._sharedStringXform = new SharedStringXform());\n  }\n\n  get values() {\n    return this.model.values;\n  }\n\n  get uniqueCount() {\n    return this.model.values.length;\n  }\n\n  get count() {\n    return this.model.count;\n  }\n\n  getString(index) {\n    return this.model.values[index];\n  }\n\n  add(value) {\n    return value.richText ? this.addRichText(value) : this.addText(value);\n  }\n\n  addText(value) {\n    let index = this.hash[value];\n    if (index === undefined) {\n      index = this.hash[value] = this.model.values.length;\n      this.model.values.push(value);\n    }\n    this.model.count++;\n    return index;\n  }\n\n  addRichText(value) {\n    // TODO: add WeakMap here\n    const xml = this.sharedStringXform.toXml(value);\n    let index = this.rich[xml];\n    if (index === undefined) {\n      index = this.rich[xml] = this.model.values.length;\n      this.model.values.push(value);\n    }\n    this.model.count++;\n    return index;\n  }\n\n  // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n  // <sst xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\" count=\"<%=totalRefs%>\" uniqueCount=\"<%=count%>\">\n  //   <si><t><%=text%></t></si>\n  //   <si><r><rPr></rPr><t></t></r></si>\n  // </sst>\n\n  render(xmlStream, model) {\n    model = model || this._values;\n    xmlStream.openXml(XmlStream.StdDocAttributes);\n\n    xmlStream.openNode('sst', {\n      xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\n      count: model.count,\n      uniqueCount: model.values.length,\n    });\n\n    const sx = this.sharedStringXform;\n    model.values.forEach(sharedString => {\n      sx.render(xmlStream, sharedString);\n    });\n    xmlStream.closeNode();\n  }\n\n  parseOpen(node) {\n    if (this.parser) {\n      this.parser.parseOpen(node);\n      return true;\n    }\n    switch (node.name) {\n      case 'sst':\n        return true;\n      case 'si':\n        this.parser = this.sharedStringXform;\n        this.parser.parseOpen(node);\n        return true;\n      default:\n        throw new Error(`Unexpected xml node in parseOpen: ${JSON.stringify(node)}`);\n    }\n  }\n\n  parseText(text) {\n    if (this.parser) {\n      this.parser.parseText(text);\n    }\n  }\n\n  parseClose(name) {\n    if (this.parser) {\n      if (!this.parser.parseClose(name)) {\n        this.model.values.push(this.parser.model);\n        this.model.count++;\n        this.parser = undefined;\n      }\n      return true;\n    }\n    switch (name) {\n      case 'sst':\n        return false;\n      default:\n        throw new Error(`Unexpected xml node in parseClose: ${name}`);\n    }\n  }\n}\n\nmodule.exports = SharedStringsXform;\n"],"mappings":"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"}