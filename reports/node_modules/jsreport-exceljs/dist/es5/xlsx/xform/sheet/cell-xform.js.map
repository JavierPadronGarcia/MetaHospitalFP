{"version":3,"file":"cell-xform.js","names":["utils","require","BaseXform","Range","Enums","RichTextXform","getValueType","v","undefined","ValueType","Null","String","Number","Boolean","Date","text","hyperlink","Hyperlink","formula","Formula","error","Error","getEffectiveCellType","cell","type","result","CellXform","richTextXForm","model","options","cellStylesCache","modelStyle","style","modelStyleKey","JSON","stringify","has","styleId","get","styles","addStyleModel","set","comment","comments","push","ref","address","sharedStrings","ssId","add","value","date1904","hyperlinks","target","tooltip","Merge","merges","shareType","si","siFormulae","formulae","sharedFormula","master","range","expandToAddress","xmlStream","attrs","t","leafNode","addAttribute","dateToExcel","openNode","richText","forEach","render","closeNode","renderFormula","node","parser","parseOpen","name","attributes","r","s","parseInt","currentNode","parseText","xmlDecode","parseFloat","parseClose","getStyleModel","getString","RichText","isDateFmt","numFmt","excelToDate","hyperlinkMap","commentsMap","module","exports"],"sources":["../../../../../lib/xlsx/xform/sheet/cell-xform.js"],"sourcesContent":["const utils = require('../../../utils/utils');\nconst BaseXform = require('../base-xform');\nconst Range = require('../../../doc/range');\nconst Enums = require('../../../doc/enums');\n\nconst RichTextXform = require('../strings/rich-text-xform');\n\nfunction getValueType(v) {\n  if (v === null || v === undefined) {\n    return Enums.ValueType.Null;\n  }\n  if (v instanceof String || typeof v === 'string') {\n    return Enums.ValueType.String;\n  }\n  if (typeof v === 'number') {\n    return Enums.ValueType.Number;\n  }\n  if (typeof v === 'boolean') {\n    return Enums.ValueType.Boolean;\n  }\n  if (v instanceof Date) {\n    return Enums.ValueType.Date;\n  }\n  if (v.text && v.hyperlink) {\n    return Enums.ValueType.Hyperlink;\n  }\n  if (v.formula) {\n    return Enums.ValueType.Formula;\n  }\n  if (v.error) {\n    return Enums.ValueType.Error;\n  }\n  throw new Error('I could not understand type of value');\n}\n\nfunction getEffectiveCellType(cell) {\n  switch (cell.type) {\n    case Enums.ValueType.Formula:\n      return getValueType(cell.result);\n    default:\n      return cell.type;\n  }\n}\n\nclass CellXform extends BaseXform {\n  constructor() {\n    super();\n\n    this.richTextXForm = new RichTextXform();\n  }\n\n  get tag() {\n    return 'c';\n  }\n\n  prepare(model, options) {\n    const {cellStylesCache} = options;\n    const modelStyle = model.style || {};\n    const modelStyleKey = JSON.stringify(modelStyle);\n\n    if (cellStylesCache.has(modelStyleKey)) {\n      model.styleId = cellStylesCache.get(modelStyleKey);\n    }\n\n    if (!model.styleId) {\n      const styleId = options.styles.addStyleModel(modelStyle, getEffectiveCellType(model));\n      if (styleId) {\n        model.styleId = styleId;\n        cellStylesCache.set(modelStyleKey, styleId);\n      }\n    }\n\n    if (model.comment) {\n      options.comments.push({...model.comment, ref: model.address});\n    }\n\n    switch (model.type) {\n      case Enums.ValueType.String:\n        if (options.sharedStrings) {\n          model.ssId = options.sharedStrings.add(model.value);\n        }\n        break;\n\n      case Enums.ValueType.Date:\n        if (options.date1904) {\n          model.date1904 = true;\n        }\n        break;\n\n      case Enums.ValueType.Hyperlink:\n        if (options.sharedStrings && model.text !== undefined && model.text !== null) {\n          model.ssId = options.sharedStrings.add(model.text);\n        }\n        options.hyperlinks.push({\n          address: model.address,\n          target: model.hyperlink,\n          tooltip: model.tooltip,\n        });\n        break;\n\n      case Enums.ValueType.Merge:\n        options.merges.add(model);\n        break;\n\n      case Enums.ValueType.Formula:\n        if (options.date1904) {\n          // in case valueType is date\n          model.date1904 = true;\n        }\n\n        if (model.shareType === 'shared') {\n          model.si = options.siFormulae++;\n        }\n\n        if (model.formula) {\n          options.formulae[model.address] = model;\n        } else if (model.sharedFormula) {\n          const master = options.formulae[model.sharedFormula];\n          if (!master) {\n            throw new Error('Shared Formula master must exist above and or left of clone');\n          }\n          if (master.si === undefined) {\n            master.shareType = 'shared';\n            master.si = options.siFormulae++;\n            master.range = new Range(master.address, model.address);\n          } else if (master.range) {\n            master.range.expandToAddress(model.address);\n          }\n          model.si = master.si;\n        }\n        break;\n\n      default:\n        break;\n    }\n  }\n\n  renderFormula(xmlStream, model) {\n    let attrs = null;\n    switch (model.shareType) {\n      case 'shared':\n        attrs = {\n          t: 'shared',\n          ref: model.ref || model.range.range,\n          si: model.si,\n        };\n        break;\n\n      case 'array':\n        attrs = {\n          t: 'array',\n          ref: model.ref,\n        };\n        break;\n\n      default:\n        if (model.si !== undefined) {\n          attrs = {\n            t: 'shared',\n            si: model.si,\n          };\n        }\n        break;\n    }\n\n    switch (getValueType(model.result)) {\n      case Enums.ValueType.Null: // ?\n        xmlStream.leafNode('f', attrs, model.formula);\n        break;\n\n      case Enums.ValueType.String:\n        // oddly, formula results don't ever use shared strings\n        xmlStream.addAttribute('t', 'str');\n        xmlStream.leafNode('f', attrs, model.formula);\n        xmlStream.leafNode('v', null, model.result);\n        break;\n\n      case Enums.ValueType.Number:\n        xmlStream.leafNode('f', attrs, model.formula);\n        xmlStream.leafNode('v', null, model.result);\n        break;\n\n      case Enums.ValueType.Boolean:\n        xmlStream.addAttribute('t', 'b');\n        xmlStream.leafNode('f', attrs, model.formula);\n        xmlStream.leafNode('v', null, model.result ? 1 : 0);\n        break;\n\n      case Enums.ValueType.Error:\n        xmlStream.addAttribute('t', 'e');\n        xmlStream.leafNode('f', attrs, model.formula);\n        xmlStream.leafNode('v', null, model.result.error);\n        break;\n\n      case Enums.ValueType.Date:\n        xmlStream.leafNode('f', attrs, model.formula);\n        xmlStream.leafNode('v', null, utils.dateToExcel(model.result, model.date1904));\n        break;\n\n      // case Enums.ValueType.Hyperlink: // ??\n      // case Enums.ValueType.Formula:\n      default:\n        throw new Error('I could not understand type of value');\n    }\n  }\n\n  render(xmlStream, model) {\n    if (model.type === Enums.ValueType.Null && !model.styleId) {\n      // if null and no style, exit\n      return;\n    }\n\n    xmlStream.openNode('c');\n    xmlStream.addAttribute('r', model.address);\n\n    if (model.styleId) {\n      xmlStream.addAttribute('s', model.styleId);\n    }\n\n    switch (model.type) {\n      case Enums.ValueType.Null:\n        break;\n\n      case Enums.ValueType.Number:\n        xmlStream.leafNode('v', null, model.value);\n        break;\n\n      case Enums.ValueType.Boolean:\n        xmlStream.addAttribute('t', 'b');\n        xmlStream.leafNode('v', null, model.value ? '1' : '0');\n        break;\n\n      case Enums.ValueType.Error:\n        xmlStream.addAttribute('t', 'e');\n        xmlStream.leafNode('v', null, model.value.error);\n        break;\n\n      case Enums.ValueType.String:\n        if (model.ssId !== undefined) {\n          xmlStream.addAttribute('t', 's');\n          xmlStream.leafNode('v', null, model.ssId);\n        } else if (model.value && model.value.richText) {\n          xmlStream.addAttribute('t', 'inlineStr');\n          xmlStream.openNode('is');\n          model.value.richText.forEach(text => {\n            this.richTextXForm.render(xmlStream, text);\n          });\n          xmlStream.closeNode('is');\n        } else {\n          xmlStream.addAttribute('t', 'str');\n          xmlStream.leafNode('v', null, model.value);\n        }\n        break;\n\n      case Enums.ValueType.Date:\n        xmlStream.leafNode('v', null, utils.dateToExcel(model.value, model.date1904));\n        break;\n\n      case Enums.ValueType.Hyperlink:\n        if (model.ssId !== undefined) {\n          xmlStream.addAttribute('t', 's');\n          xmlStream.leafNode('v', null, model.ssId);\n        } else {\n          xmlStream.addAttribute('t', 'str');\n          xmlStream.leafNode('v', null, model.text);\n        }\n        break;\n\n      case Enums.ValueType.Formula:\n        this.renderFormula(xmlStream, model);\n        break;\n\n      case Enums.ValueType.Merge:\n        // nothing to add\n        break;\n\n      default:\n        break;\n    }\n\n    xmlStream.closeNode(); // </c>\n  }\n\n  parseOpen(node) {\n    if (this.parser) {\n      this.parser.parseOpen(node);\n      return true;\n    }\n    switch (node.name) {\n      case 'c':\n        // const address = colCache.decodeAddress(node.attributes.r);\n        this.model = {\n          address: node.attributes.r,\n        };\n        this.t = node.attributes.t;\n        if (node.attributes.s) {\n          this.model.styleId = parseInt(node.attributes.s, 10);\n        }\n        return true;\n\n      case 'f':\n        this.currentNode = 'f';\n        this.model.si = node.attributes.si;\n        this.model.shareType = node.attributes.t;\n        this.model.ref = node.attributes.ref;\n        return true;\n\n      case 'v':\n        this.currentNode = 'v';\n        return true;\n\n      case 't':\n        this.currentNode = 't';\n        return true;\n\n      case 'r':\n        this.parser = this.richTextXForm;\n        this.parser.parseOpen(node);\n        return true;\n\n      default:\n        return false;\n    }\n  }\n\n  parseText(text) {\n    if (this.parser) {\n      this.parser.parseText(text);\n      return;\n    }\n    switch (this.currentNode) {\n      case 'f':\n        this.model.formula = this.model.formula ? this.model.formula + text : text;\n        break;\n      case 'v':\n      case 't':\n        if (this.model.value && this.model.value.richText) {\n          this.model.value.richText.text = this.model.value.richText.text ? this.model.value.richText.text + text : text;\n        } else {\n          this.model.value = this.model.value ? this.model.value + text : text;\n        }\n        break;\n      default:\n        break;\n    }\n  }\n\n  parseClose(name) {\n    switch (name) {\n      case 'c': {\n        const {model} = this;\n\n        // first guess on cell type\n        if (model.formula || model.shareType) {\n          model.type = Enums.ValueType.Formula;\n          if (model.value) {\n            if (this.t === 'str') {\n              model.result = utils.xmlDecode(model.value);\n            } else if (this.t === 'b') {\n              model.result = parseInt(model.value, 10) !== 0;\n            } else if (this.t === 'e') {\n              model.result = {error: model.value};\n            } else {\n              model.result = parseFloat(model.value);\n            }\n            model.value = undefined;\n          }\n        } else if (model.value !== undefined) {\n          switch (this.t) {\n            case 's':\n              model.type = Enums.ValueType.String;\n              model.value = parseInt(model.value, 10);\n              break;\n            case 'str':\n              model.type = Enums.ValueType.String;\n              model.value = utils.xmlDecode(model.value);\n              break;\n            case 'inlineStr':\n              model.type = Enums.ValueType.String;\n              break;\n            case 'b':\n              model.type = Enums.ValueType.Boolean;\n              model.value = parseInt(model.value, 10) !== 0;\n              break;\n            case 'e':\n              model.type = Enums.ValueType.Error;\n              model.value = {error: model.value};\n              break;\n            default:\n              model.type = Enums.ValueType.Number;\n              model.value = parseFloat(model.value);\n              break;\n          }\n        } else if (model.styleId) {\n          model.type = Enums.ValueType.Null;\n        } else {\n          model.type = Enums.ValueType.Merge;\n        }\n        return false;\n      }\n\n      case 'f':\n      case 'v':\n      case 'is':\n        this.currentNode = undefined;\n        return true;\n\n      case 't':\n        if (this.parser) {\n          this.parser.parseClose(name);\n          return true;\n        }\n        this.currentNode = undefined;\n        return true;\n\n      case 'r':\n        this.model.value = this.model.value || {};\n        this.model.value.richText = this.model.value.richText || [];\n        this.model.value.richText.push(this.parser.model);\n        this.parser = undefined;\n        this.currentNode = undefined;\n        return true;\n\n      default:\n        if (this.parser) {\n          this.parser.parseClose(name);\n          return true;\n        }\n        return false;\n    }\n  }\n\n  reconcile(model, options) {\n    const style = model.styleId && options.styles && options.styles.getStyleModel(model.styleId);\n    if (style) {\n      model.style = style;\n    }\n    if (model.styleId !== undefined) {\n      model.styleId = undefined;\n    }\n\n    switch (model.type) {\n      case Enums.ValueType.String:\n        if (typeof model.value === 'number') {\n          if (options.sharedStrings) {\n            model.value = options.sharedStrings.getString(model.value);\n          }\n        }\n        if (model.value.richText) {\n          model.type = Enums.ValueType.RichText;\n        }\n        break;\n\n      case Enums.ValueType.Number:\n        if (style && utils.isDateFmt(style.numFmt)) {\n          model.type = Enums.ValueType.Date;\n          model.value = utils.excelToDate(model.value, options.date1904);\n        }\n        break;\n\n      case Enums.ValueType.Formula:\n        if (model.result !== undefined && style && utils.isDateFmt(style.numFmt)) {\n          model.result = utils.excelToDate(model.result, options.date1904);\n        }\n        if (model.shareType === 'shared') {\n          if (model.ref) {\n            // master\n            options.formulae[model.si] = model.address;\n          } else {\n            // slave\n            model.sharedFormula = options.formulae[model.si];\n            delete model.shareType;\n          }\n          delete model.si;\n        }\n        break;\n\n      default:\n        break;\n    }\n\n    // look for hyperlink\n    const hyperlink = options.hyperlinkMap[model.address];\n    if (hyperlink) {\n      if (model.type === Enums.ValueType.Formula) {\n        model.text = model.result;\n        model.result = undefined;\n      } else {\n        model.text = model.value;\n        model.value = undefined;\n      }\n      model.type = Enums.ValueType.Hyperlink;\n      model.hyperlink = hyperlink;\n    }\n\n    const comment = options.commentsMap && options.commentsMap[model.address];\n    if (comment) {\n      model.comment = comment;\n    }\n  }\n}\n\nmodule.exports = CellXform;\n"],"mappings":"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"}