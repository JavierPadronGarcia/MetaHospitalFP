{"version":3,"file":"xml-stream.js","names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","EQUALS_QUOTE","QUOTE","SPACE","pushAttribute","xml","name","value","push","xmlEncode","toString","pushAttributes","attributes","each","undefined","XmlStream","_xml","_stack","_rollbacks","length","docAttributes","parent","tos","open","leaf","Error","attrs","text","node","pop","openNode","writeText","closeNode","stack","cursor","r","splice","closeAll","join","StdDocAttributes","version","encoding","standalone","module","exports"],"sources":["../../../lib/utils/xml-stream.js"],"sourcesContent":["const _ = require('./under-dash');\n\nconst utils = require('./utils');\n\n// constants\nconst OPEN_ANGLE = '<';\nconst CLOSE_ANGLE = '>';\nconst OPEN_ANGLE_SLASH = '</';\nconst CLOSE_SLASH_ANGLE = '/>';\nconst EQUALS_QUOTE = '=\"';\nconst QUOTE = '\"';\nconst SPACE = ' ';\n\nfunction pushAttribute(xml, name, value) {\n  xml.push(SPACE);\n  xml.push(name);\n  xml.push(EQUALS_QUOTE);\n  xml.push(utils.xmlEncode(value.toString()));\n  xml.push(QUOTE);\n}\nfunction pushAttributes(xml, attributes) {\n  if (attributes) {\n    _.each(attributes, (value, name) => {\n      if (value !== undefined) {\n        pushAttribute(xml, name, value);\n      }\n    });\n  }\n}\n\nclass XmlStream {\n  constructor() {\n    this._xml = [];\n    this._stack = [];\n    this._rollbacks = [];\n  }\n\n  get tos() {\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\n  }\n\n  get cursor() {\n    // handy way to track whether anything has been added\n    return this._xml.length;\n  }\n\n  openXml(docAttributes) {\n    const xml = this._xml;\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n    xml.push('<?xml');\n    pushAttributes(xml, docAttributes);\n    xml.push('?>\\n');\n  }\n\n  openNode(name, attributes) {\n    const parent = this.tos;\n    const xml = this._xml;\n    if (parent && this.open) {\n      xml.push(CLOSE_ANGLE);\n    }\n\n    this._stack.push(name);\n\n    // start streaming node\n    xml.push(OPEN_ANGLE);\n    xml.push(name);\n    pushAttributes(xml, attributes);\n    this.leaf = true;\n    this.open = true;\n  }\n\n  addAttribute(name, value) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    if (value !== undefined) {\n      pushAttribute(this._xml, name, value);\n    }\n  }\n\n  addAttributes(attrs) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    pushAttributes(this._xml, attrs);\n  }\n\n  writeText(text) {\n    const xml = this._xml;\n    if (this.open) {\n      xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    xml.push(utils.xmlEncode(text.toString()));\n  }\n\n  writeXml(xml) {\n    if (this.open) {\n      this._xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    this._xml.push(xml);\n  }\n\n  closeNode() {\n    const node = this._stack.pop();\n    const xml = this._xml;\n    if (this.leaf) {\n      xml.push(CLOSE_SLASH_ANGLE);\n    } else {\n      xml.push(OPEN_ANGLE_SLASH);\n      xml.push(node);\n      xml.push(CLOSE_ANGLE);\n    }\n    this.open = false;\n    this.leaf = false;\n  }\n\n  leafNode(name, attributes, text) {\n    this.openNode(name, attributes);\n    if (text !== undefined) {\n      // zeros need to be written\n      this.writeText(text);\n    }\n    this.closeNode();\n  }\n\n  closeAll() {\n    while (this._stack.length) {\n      this.closeNode();\n    }\n  }\n\n  addRollback() {\n    this._rollbacks.push({\n      xml: this._xml.length,\n      stack: this._stack.length,\n      leaf: this.leaf,\n      open: this.open,\n    });\n    return this.cursor;\n  }\n\n  commit() {\n    this._rollbacks.pop();\n  }\n\n  rollback() {\n    const r = this._rollbacks.pop();\n    if (this._xml.length > r.xml) {\n      this._xml.splice(r.xml, this._xml.length - r.xml);\n    }\n    if (this._stack.length > r.stack) {\n      this._stack.splice(r.stack, this._stack.length - r.stack);\n    }\n    this.leaf = r.leaf;\n    this.open = r.open;\n  }\n\n  get xml() {\n    this.closeAll();\n    return this._xml.join('');\n  }\n}\n\nXmlStream.StdDocAttributes = {\n  version: '1.0',\n  encoding: 'UTF-8',\n  standalone: 'yes',\n};\n\nmodule.exports = XmlStream;\n"],"mappings":"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"}