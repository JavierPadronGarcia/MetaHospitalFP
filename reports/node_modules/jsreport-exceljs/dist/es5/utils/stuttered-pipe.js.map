{"version":3,"file":"stuttered-pipe.js","names":["events","require","StutteredPipe","readable","writable","options","bufSize","autoPause","paused","eod","scheduled","on","end","resume","_schedule","clearImmediate","setImmediate","data","read","length","write","EventEmitter","module","exports"],"sources":["../../../lib/utils/stuttered-pipe.js"],"sourcesContent":["const events = require('events');\n\n// =============================================================================\n// StutteredPipe - Used to slow down streaming so GC can get a look in\nclass StutteredPipe extends events.EventEmitter {\n  constructor(readable, writable, options) {\n    super();\n\n    options = options || {};\n\n    this.readable = readable;\n    this.writable = writable;\n    this.bufSize = options.bufSize || 16384;\n    this.autoPause = options.autoPause || false;\n\n    this.paused = false;\n    this.eod = false;\n    this.scheduled = null;\n\n    readable.on('end', () => {\n      this.eod = true;\n      writable.end();\n    });\n\n    // need to have some way to communicate speed of stream\n    // back from the consumer\n    readable.on('readable', () => {\n      if (!this.paused) {\n        this.resume();\n      }\n    });\n    this._schedule();\n  }\n\n  pause() {\n    this.paused = true;\n  }\n\n  resume() {\n    if (!this.eod) {\n      if (this.scheduled !== null) {\n        clearImmediate(this.scheduled);\n      }\n      this._schedule();\n    }\n  }\n\n  _schedule() {\n    this.scheduled = setImmediate(() => {\n      this.scheduled = null;\n      if (!this.eod && !this.paused) {\n        const data = this.readable.read(this.bufSize);\n        if (data && data.length) {\n          this.writable.write(data);\n\n          if (!this.paused && !this.autoPause) {\n            this._schedule();\n          }\n        } else if (!this.paused) {\n          this._schedule();\n        }\n      }\n    });\n  }\n}\n\nmodule.exports = StutteredPipe;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAMA,MAAM,GAAGC,OAAO,CAAC,QAAD,CAAtB,C,CAEA;AACA;;;IACMC,a;;;;;EACJ,uBAAYC,QAAZ,EAAsBC,QAAtB,EAAgCC,OAAhC,EAAyC;IAAA;;IAAA;;IACvC;IAEAA,OAAO,GAAGA,OAAO,IAAI,EAArB;IAEA,MAAKF,QAAL,GAAgBA,QAAhB;IACA,MAAKC,QAAL,GAAgBA,QAAhB;IACA,MAAKE,OAAL,GAAeD,OAAO,CAACC,OAAR,IAAmB,KAAlC;IACA,MAAKC,SAAL,GAAiBF,OAAO,CAACE,SAAR,IAAqB,KAAtC;IAEA,MAAKC,MAAL,GAAc,KAAd;IACA,MAAKC,GAAL,GAAW,KAAX;IACA,MAAKC,SAAL,GAAiB,IAAjB;IAEAP,QAAQ,CAACQ,EAAT,CAAY,KAAZ,EAAmB,YAAM;MACvB,MAAKF,GAAL,GAAW,IAAX;MACAL,QAAQ,CAACQ,GAAT;IACD,CAHD,EAduC,CAmBvC;IACA;;IACAT,QAAQ,CAACQ,EAAT,CAAY,UAAZ,EAAwB,YAAM;MAC5B,IAAI,CAAC,MAAKH,MAAV,EAAkB;QAChB,MAAKK,MAAL;MACD;IACF,CAJD;;IAKA,MAAKC,SAAL;;IA1BuC;EA2BxC;;;;WAED,iBAAQ;MACN,KAAKN,MAAL,GAAc,IAAd;IACD;;;WAED,kBAAS;MACP,IAAI,CAAC,KAAKC,GAAV,EAAe;QACb,IAAI,KAAKC,SAAL,KAAmB,IAAvB,EAA6B;UAC3BK,cAAc,CAAC,KAAKL,SAAN,CAAd;QACD;;QACD,KAAKI,SAAL;MACD;IACF;;;WAED,qBAAY;MAAA;;MACV,KAAKJ,SAAL,GAAiBM,YAAY,CAAC,YAAM;QAClC,MAAI,CAACN,SAAL,GAAiB,IAAjB;;QACA,IAAI,CAAC,MAAI,CAACD,GAAN,IAAa,CAAC,MAAI,CAACD,MAAvB,EAA+B;UAC7B,IAAMS,IAAI,GAAG,MAAI,CAACd,QAAL,CAAce,IAAd,CAAmB,MAAI,CAACZ,OAAxB,CAAb;;UACA,IAAIW,IAAI,IAAIA,IAAI,CAACE,MAAjB,EAAyB;YACvB,MAAI,CAACf,QAAL,CAAcgB,KAAd,CAAoBH,IAApB;;YAEA,IAAI,CAAC,MAAI,CAACT,MAAN,IAAgB,CAAC,MAAI,CAACD,SAA1B,EAAqC;cACnC,MAAI,CAACO,SAAL;YACD;UACF,CAND,MAMO,IAAI,CAAC,MAAI,CAACN,MAAV,EAAkB;YACvB,MAAI,CAACM,SAAL;UACD;QACF;MACF,CAd4B,CAA7B;IAeD;;;;EA3DyBd,MAAM,CAACqB,Y;;AA8DnCC,MAAM,CAACC,OAAP,GAAiBrB,aAAjB"}